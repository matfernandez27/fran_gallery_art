<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin — Obras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto p-6">
      <h1 class="text-2xl font-bold">Panel de Administración</h1>
      <p class="text-sm text-gray-500">Gestionar obras y catálogo</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 space-y-8">

    <!-- Formulario para nueva obra -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Agregar nueva obra</h2>
      <form id="obra-form" class="space-y-4">
        <input id="title" type="text" placeholder="Título"
          class="w-full p-3 border rounded-lg" required />
        <input id="year" type="number" placeholder="Año"
          class="w-full p-3 border rounded-lg" required />
        <input id="technique" type="text" placeholder="Técnica"
          class="w-full p-3 border rounded-lg" />
        <input id="size" type="text" placeholder="Medidas"
          class="w-full p-3 border rounded-lg" />
        <textarea id="description" placeholder="Descripción"
          class="w-full p-3 border rounded-lg"></textarea>
        <input id="images" type="file" multiple accept="image/*"
          class="w-full p-3 border rounded-lg" />
        <button type="submit"
          class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Guardar obra</button>
      </form>
    </section>

    <!-- Lista de obras -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Listado de obras</h2>
      <ul id="obra-list" class="space-y-4">
        <!-- Items generados por JS -->
      </ul>
    </section>
  </main>

  <script>
    const client = supabase.createClient(
      "https://railkoprsjevdyrxalfu.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhaWxrb3Byc2pldmR5cnhhbGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjU2ODEsImV4cCI6MjA3NDM0MTY4MX0.cXlcz00HmgBAzsTmqQl7lKZPWR9f3STsLFBFBTiucR0"
    );

    const obraForm = document.getElementById("obra-form");
    const obraList = document.getElementById("obra-list");

    let obras = [];

    // Renderizar listado
    function renderObras() {
      obraList.innerHTML = obras.map(o => `
        <li class="p-4 border rounded-lg bg-gray-50" data-id="${o.id}">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold">${o.title}</h3>
              <p class="text-sm text-gray-600">${o.year} · ${o.technique || ""} · ${o.size || ""}</p>
            </div>
            <button onclick="deleteObra(${o.id})"
              class="bg-red-500 text-white px-3 py-1 rounded">Eliminar</button>
          </div>
          <div class="flex gap-2 mt-2 flex-wrap">
            ${(o.imagenes || []).map(img => `
              <div class="relative group">
                <img src="${img.url}" class="w-24 h-24 object-cover rounded">
                <button onclick="deleteImage(${o.id}, '${img.path}')"
                  class="absolute top-1 right-1 bg-black bg-opacity-60 text-white text-xs px-1 rounded hidden group-hover:block">✕</button>
              </div>
            `).join("")}
          </div>
        </li>
      `).join("");

      // Activar drag & drop
      new Sortable(obraList, {
        animation: 150,
        onEnd: saveOrder
      });
    }

    // Cargar obras
    async function fetchObras() {
      const { data, error } = await client
        .from("productos")
        .select("*")
        .order("orden", { ascending: true });

      if (error) {
        console.error("Error cargando obras:", error);
        return;
      }
      obras = data;
      renderObras();
    }

    // Guardar nueva obra
    obraForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const year = document.getElementById("year").value;
      const technique = document.getElementById("technique").value;
      const size = document.getElementById("size").value;
      const description = document.getElementById("description").value;
      const files = document.getElementById("images").files;

      let imagenes = [];
      for (let f of files) {
        const filePath = `${Date.now()}_${f.name}`;
        const { error: uploadError } = await client.storage
          .from("imagenes")
          .upload(filePath, f, { upsert: true });
        if (uploadError) {
          console.error("Error subiendo archivo:", uploadError);
          continue;
        }
        const { data } = client.storage.from("imagenes").getPublicUrl(filePath);
        imagenes.push({ url: data.publicUrl, path: filePath });
      }

      const { data, error } = await client
        .from("productos")
        .insert([{ title, year, technique, size, description, imagenes }])
        .select();

      if (error) {
        console.error("Error guardando obra:", error);
        return;
      }

      obras.unshift(data[0]);
      renderObras();
      obraForm.reset();
    });

    // Eliminar obra completa (con imágenes)
    async function deleteObra(id) {
      const obra = obras.find(o => o.id === id);
      if (!obra) return;
      if (!confirm("¿Eliminar esta obra y todas sus imágenes?")) return;

      for (let img of obra.imagenes || []) {
        await client.storage.from("imagenes").remove([img.path]);
      }
      await client.from("productos").delete().eq("id", id);
      obras = obras.filter(o => o.id !== id);
      renderObras();
    }

    // Eliminar solo una imagen
    async function deleteImage(obraId, path) {
      const obra = obras.find(o => o.id === obraId);
      if (!obra) return;
      await client.storage.from("imagenes").remove([path]);
      const nuevas = (obra.imagenes || []).filter(img => img.path !== path);
      await client.from("productos").update({ imagenes: nuevas }).eq("id", obraId);
      obra.imagenes = nuevas;
      renderObras();
    }

    // Guardar orden
    async function saveOrder() {
      const ids = [...obraList.children].map(li => li.dataset.id);
      for (let i = 0; i < ids.length; i++) {
        await client.from("productos").update({ orden: i }).eq("id", ids[i]);
      }
      fetchObras();
    }

    // Inicializar
    fetchObras();
  </script>
</body>
</html>