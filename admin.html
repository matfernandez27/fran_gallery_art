<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 text-sm rounded-lg shadow-xl z-50 w-11/12 md:w-auto" role="alert"></div>

    <header id="admin-header" class="bg-white shadow hidden">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                Cerrar Sesión
            </button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <div id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl mt-20">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-4">
                <input id="login-email" type="email" placeholder="Correo Electrónico" class="w-full p-3 border rounded-lg" required />
                <input id="login-password" type="password" placeholder="Contraseña" class="w-full p-3 border rounded-lg" required />
                <button type="submit" id="login-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full">
                    Acceder
                </button>
            </form>
        </div>

        <div id="admin-section" class="hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-6">Gestionar obras y catálogo</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Agregar nueva obra</h3>
                
                <form id="obra-form" class="space-y-4">
                    <input id="title" type="text" placeholder="Título *" class="w-full p-3 border rounded-lg" required />
                    <input id="year" type="number" placeholder="Año (ej: 2023) *" class="w-full p-3 border rounded-lg" required />
                    <input id="technique" type="text" placeholder="Técnica (ej: Óleo sobre lienzo) *" class="w-full p-3 border rounded-lg" required />
                    <input id="size" type="text" placeholder="Medidas (ej: 90x40 cm) *" class="w-full p-3 border rounded-lg" required />
                    
                    <select id="category" class="w-full p-3 border rounded-lg" required>
                        <option value="">Seleccionar Categoría *</option>
                        <option value="grabado">Grabado</option>
                        <option value="dibujo">Dibujo</option>
                        <option value="pintura">Pintura</option>
                    </select>

                    <input id="serie" type="text" placeholder="Serie (opcional)" class="w-full p-3 border rounded-lg" />
                    
                    <textarea id="description" placeholder="Descripción de la obra" class="w-full p-3 border rounded-lg h-32"></textarea>
                    
                    <label class="block text-gray-700 font-semibold pt-2">Seleccionar Imágenes (Múltiples)</label>
                    <input id="image-files" type="file" accept="image/*" multiple required class="w-full p-3 border rounded-lg bg-gray-50" />
                    
                    <button type="submit" id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full">
                        Guardar obra
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Obras existentes (Gestión)</h3>
                <div id="obra-list" class="space-y-4">
                    <p class="text-gray-500">Cargando lista de obras...</p>
                    </div>
            </div>
        </div>
    </main>
    
    <script>
        // Inicialización de Supabase
        const supabaseUrl = window.supabaseUrl;
        const supabaseAnonKey = window.supabaseAnonKey;
        const client = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- ELEMENTOS DEL DOM ---
        const loginSection = document.getElementById("login-section");
        const loginForm = document.getElementById("login-form");
        const adminSection = document.getElementById("admin-section");
        const adminHeader = document.getElementById("admin-header");
        const obraForm = document.getElementById("obra-form");
        const logoutButton = document.getElementById("logout-button");
        const imageFilesInput = document.getElementById("image-files");
        const alertDiv = document.getElementById("alert");
        const obraListDiv = document.getElementById("obra-list"); 
        
        // --- CONFIGURACIÓN ---
        const BUCKET_NAME = 'imagenes';
        const IMAGE_FOLDER = 'images'; 

        // --- FUNCIONES DE UTILIDAD ---

        function showAlert(message, type = 'success') {
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            alertDiv.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (type === 'error') {
                alertDiv.classList.add('bg-red-100', 'text-red-700');
            } else {
                alertDiv.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => alertDiv.classList.add('hidden'), 5000);
        }

        function toggleAdminView(isAuthenticated) {
            if (isAuthenticated) {
                loginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                adminHeader.classList.remove('hidden');
                loadObraList(); 
            } else {
                loginSection.classList.remove('hidden');
                adminSection.classList.add('hidden');
                adminHeader.classList.add('hidden');
            }
        }

        async function checkAuth() {
            const { data: { user } } = await client.auth.getUser();
            toggleAdminView(!!user);
        }
        
        // --- GESTIÓN DE AUTH ---

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const loginButton = document.getElementById("login-button");
            
            loginButton.textContent = "Accediendo...";
            loginButton.disabled = true;

            const { error } = await client.auth.signInWithPassword({ email, password });

            if (error) {
                showAlert(`Error de acceso: ${error.message}`, 'error');
            } else {
                showAlert("¡Acceso exitoso!", 'success');
                checkAuth();
            }
            loginButton.textContent = "Acceder";
            loginButton.disabled = false;
        });

        logoutButton.addEventListener("click", async () => {
            const { error } = await client.auth.signOut();
            if (!error) {
                showAlert("Sesión cerrada.", 'success');
                checkAuth();
            } else {
                showAlert("Error al cerrar sesión.", 'error');
            }
        });

        // --- SUBIDA DE ARCHIVOS A SUPABASE STORAGE ---
        async function uploadFiles(files, obraTitle) {
            const uploadedImages = [];
            
            for (const file of files) {
                const safeTitle = obraTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                const filePath = `${IMAGE_FOLDER}/${safeTitle}-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;

                const { data, error } = await client.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file, { cacheControl: '3600', upsert: false });

                if (error) {
                    throw new Error(`Error subiendo imagen: ${error.message}`);
                }

                const { data: publicUrl } = client.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);

                uploadedImages.push({ url: publicUrl.publicUrl, path: filePath, originalName: file.name });
            }
            return uploadedImages;
        }

        // --- GESTIÓN DE FORMULARIO DE OBRA ---
        obraForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const title = document.getElementById("title").value.trim();
            const year = parseInt(document.getElementById("year").value.trim());
            const technique = document.getElementById("technique").value.trim();
            const size = document.getElementById("size").value.trim();
            const description = document.getElementById("description").value.trim();
            const files = imageFilesInput.files;
            const category = document.getElementById("category").value; 
            const serie = document.getElementById("serie").value.trim(); 
            
            if (!files.length) {
                showAlert("Debe seleccionar al menos una imagen.", 'error');
                return;
            }

            const saveButton = e.submitter;
            saveButton.textContent = "Guardando...";
            saveButton.disabled = true;

            try {
                // 1. Obtener el siguiente valor de 'orden'
                const { data: maxOrder } = await client.from('productos').select('orden').order('orden', { ascending: false }).limit(1);
                const newOrder = (maxOrder && maxOrder.length > 0) ? maxOrder[0].orden + 1 : 1;

                // 2. Subir archivos a Storage
                const uploadedImages = await uploadFiles(files, title);
                
                // 3. Insertar registro en la tabla 'productos'
                const { error: insertError } = await client
                    .from("productos")
                    .insert([{
                        titulo: title, anio: year, tecnica: technique, medidas: size, descripcion: description, 
                        imagenes: uploadedImages, orden: newOrder, categoria: category, serie: serie
                    }]);

                if (insertError) throw new Error("Error al insertar en DB: " + insertError.message);

                showAlert("Obra guardada exitosamente!", 'success');
                obraForm.reset();
                loadObraList(); 
            } catch (error) {
                console.error(error);
                showAlert(error.message, 'error');
            } finally {
                saveButton.textContent = "Guardar obra";
                saveButton.disabled = false;
            }
        });

        // --- GESTIÓN DE LISTA DE OBRAS Y BORRADO ---

        async function loadObraList() {
            obraListDiv.innerHTML = '<p class="text-gray-500">Cargando lista de obras...</p>';
            
            const { data, error } = await client
                .from('productos')
                .select('id, titulo, anio, tecnica, imagenes, created_at')
                .order('created_at', { ascending: false }); 

            if (error) {
                obraListDiv.innerHTML = `<p class="text-red-500">Error al cargar obras: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                obraListDiv.innerHTML = '<p class="text-gray-500">No hay obras subidas aún.</p>';
                return;
            }

            obraListDiv.innerHTML = ''; 
            
            data.forEach(obra => {
                const item = document.createElement('div');
                const mainImage = obra.imagenes && obra.imagenes.length > 0 ? obra.imagenes[0].url : '';
                
                item.className = 'flex items-center space-x-4 p-3 border-b hover:bg-gray-50 rounded-lg transition duration-150';
                item.setAttribute('id', `obra-item-${obra.id}`); 
                
                // 1. Convertir el objeto imágenes a una cadena JSON.
                const jsonString = JSON.stringify(obra.imagenes);
                // 2. CODIFICAR LA CADENA JSON a Base64 para evitar CUALQUIER error de sintaxis en el HTML.
                const base64Images = btoa(jsonString);

                item.innerHTML = `
                    <img src="${mainImage}" alt="${obra.titulo}" class="w-16 h-16 object-cover rounded-md" onerror="this.style.display='none'" />
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${obra.titulo} (${obra.anio})</h4>
                        <p class="text-sm text-gray-500">${obra.tecnica}</p>
                    </div>
                    <div>
                        <button id="delete-btn-${obra.id}" onclick="deleteObra(${obra.id}, '${base64Images}', this)" class="bg-red-500 hover:bg-red-600 text-white text-sm py-2 px-3 rounded-lg transition duration-300">
                            Eliminar
                        </button>
                    </div>
                `;
                obraListDiv.appendChild(item);
            });
        }
        
        // Se pasa el botón como argumento para deshabilitarlo durante la operación
        async function deleteObra(id, base64Images, button) {
            let images = [];
            try {
                // 1. Decodificar de Base64
                const jsonString = atob(base64Images);
                // 2. Parsear el JSON
                images = JSON.parse(jsonString);
            } catch (e) {
                console.error("Error al decodificar/parsear imágenes:", e);
                showAlert("Error interno al preparar la eliminación. Los datos de la imagen no son válidos.", 'error');
                return;
            }


            if (!confirm(`¿Está seguro de eliminar la obra con ID ${id} y todas sus imágenes? Esta acción es irreversible.`)) {
                return;
            }
            
            const originalText = button.textContent;
            button.textContent = 'Borrando...';
            button.disabled = true;

            try {
                // 1. Eliminar el registro de la DB
                const { error: dbError } = await client
                    .from('productos')
                    .delete()
                    .eq('id', id);

                if (dbError) {
                    throw new Error(`Error al eliminar el registro: ${dbError.message}.`);
                }

                // 2. Eliminar las imágenes del Storage
                const filePaths = images.map(img => img.path).filter(Boolean);

                if (filePaths.length > 0) {
                    const { error: storageError } = await client.storage
                        .from(BUCKET_NAME)
                        .remove(filePaths);

                    if (storageError && storageError.statusCode !== '200') {
                        // Si falla el Storage, notificamos, pero el registro de la DB ya se fue
                        console.warn("Error al borrar imágenes del storage:", storageError);
                        showAlert(`Obra eliminada de la DB. ADVERTENCIA: Falló el borrado de ${filePaths.length} imagen(es) del Storage.`, 'error');
                        return; // Salimos después de notificar el problema de Storage
                    }
                }

                // 3. Éxito
                showAlert("Obra y archivos eliminados exitosamente!", 'success');
                // Remover el elemento del DOM inmediatamente sin recargar toda la lista
                document.getElementById(`obra-item-${id}`).remove(); 

            } catch (error) {
                console.error(error);
                showAlert(error.message, 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Hacer la función deleteObra accesible globalmente para el onclick
        window.deleteObra = deleteObra;

        // Inicializar
        checkAuth();
    </script>
</body>
</html>