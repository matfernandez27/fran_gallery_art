<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 text-sm rounded-lg shadow-xl z-50 w-11/12 md:w-auto" role="alert"></div>

    <header id="admin-header" class="bg-white shadow hidden">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                Cerrar Sesión
            </button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <div id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl mt-20">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-4">
                <input id="login-email" type="email" placeholder="Correo Electrónico" class="w-full p-3 border rounded-lg" required />
                <input id="login-password" type="password" placeholder="Contraseña" class="w-full p-3 border rounded-lg" required />
                <button type="submit" id="login-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full">
                    Acceder
                </button>
            </form>
        </div>

        <div id="admin-section" class="hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-6">Gestionar obras y catálogo</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Agregar nueva obra</h3>
                
                <form id="obra-form" class="space-y-4">
                    <input id="title" type="text" placeholder="Título *" class="w-full p-3 border rounded-lg" required />
                    <input id="year" type="number" placeholder="Año (ej: 2023) *" class="w-full p-3 border rounded-lg" required />
                    <input id="technique" type="text" placeholder="Técnica (ej: Óleo sobre lienzo) *" class="w-full p-3 border rounded-lg" required />
                    <input id="size" type="text" placeholder="Medidas (ej: 90x40 cm) *" class="w-full p-3 border rounded-lg" required />
                    
                    <select id="category" class="w-full p-3 border rounded-lg" required>
                        <option value="">Seleccionar Categoría *</option>
                        <option value="grabado">Grabado</option>
                        <option value="dibujo">Dibujo</option>
                        <option value="pintura">Pintura</option>
                    </select>

                    <input id="serie" type="text" placeholder="Serie (opcional)" class="w-full p-3 border rounded-lg" />
                    
                    <textarea id="description" placeholder="Descripción de la obra" class="w-full p-3 border rounded-lg h-32"></textarea>
                    
                    <label class="block text-gray-700 font-semibold pt-2">Seleccionar Imágenes (Múltiples)</label>
                    <input id="image-files" type="file" accept="image/*" multiple required class="w-full p-3 border rounded-lg bg-gray-50" />
                    
                    <button type="submit" id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full disabled:opacity-50">
                        Guardar obra
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Obras existentes (Gestión)</h3>
                <p class="text-gray-500">Esta sección requiere lógica adicional para mostrar, editar y reordenar las obras.</p>
            </div>
        </div>
    </main>
    
    <script>
        // Inicialización de Supabase
        const supabaseUrl = window.supabaseUrl;
        const supabaseAnonKey = window.supabaseAnonKey;
        const client = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- ELEMENTOS DEL DOM ---
        const loginSection = document.getElementById("login-section");
        const loginForm = document.getElementById("login-form");
        const adminSection = document.getElementById("admin-section");
        const adminHeader = document.getElementById("admin-header");
        const obraForm = document.getElementById("obra-form");
        const logoutButton = document.getElementById("logout-button");
        const imageFilesInput = document.getElementById("image-files");
        const alertDiv = document.getElementById("alert");
        
        // --- CONFIGURACIÓN ---
        const BUCKET_NAME = 'imagenes';
        const IMAGE_FOLDER = 'images'; 

        // --- FUNCIONES DE UTILIDAD ---

        function showAlert(message, type = 'success') {
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            alertDiv.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (type === 'error') {
                alertDiv.classList.add('bg-red-100', 'text-red-700');
            } else {
                alertDiv.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => alertDiv.classList.add('hidden'), 5000);
        }

        function toggleAdminView(isAuthenticated) {
            if (isAuthenticated) {
                loginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                adminHeader.classList.remove('hidden');
            } else {
                loginSection.classList.remove('hidden');
                adminSection.classList.add('hidden');
                adminHeader.classList.add('hidden');
            }
        }

        async function checkAuth() {
            const { data: { user } } = await client.auth.getUser();
            toggleAdminView(!!user);
        }
        
        // --- GESTIÓN DE AUTH ---

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const loginButton = document.getElementById("login-button");
            
            loginButton.textContent = "Accediendo...";
            loginButton.disabled = true;

            const { error } = await client.auth.signInWithPassword({ email, password });

            if (error) {
                showAlert(`Error de acceso: ${error.message}`, 'error');
            } else {
                // Redirige o simplemente actualiza la vista
                showAlert("¡Acceso exitoso!", 'success');
                checkAuth();
            }
            loginButton.textContent = "Acceder";
            loginButton.disabled = false;
        });

        logoutButton.addEventListener("click", async () => {
            const { error } = await client.auth.signOut();
            if (!error) {
                showAlert("Sesión cerrada.", 'success');
                checkAuth(); // Vuelve a la vista de login
            } else {
                showAlert("Error al cerrar sesión.", 'error');
            }
        });

        // --- SUBIDA DE ARCHIVOS A SUPABASE STORAGE ---
        async function uploadFiles(files, obraTitle) {
            const uploadedImages = [];
            
            for (const file of files) {
                const safeTitle = obraTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                const filePath = `${IMAGE_FOLDER}/${safeTitle}-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;

                const { data, error } = await client.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    throw new Error(`Error subiendo imagen: ${error.message}`);
                }

                const { data: publicUrl } = client.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);

                uploadedImages.push({
                    url: publicUrl.publicUrl,
                    path: filePath,
                    originalName: file.name
                });
            }
            return uploadedImages;
        }

        // --- GESTIÓN DE FORMULARIO DE OBRA (MODIFICADO) ---
        obraForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const title = document.getElementById("title").value.trim();
            const year = parseInt(document.getElementById("year").value.trim());
            const technique = document.getElementById("technique").value.trim();
            const size = document.getElementById("size").value.trim();
            const description = document.getElementById("description").value.trim();
            const files = imageFilesInput.files;

            // NUEVOS CAMPOS
            const category = document.getElementById("category").value; 
            const serie = document.getElementById("serie").value.trim(); 
            
            if (!files.length) {
                showAlert("Debe seleccionar al menos una imagen.", 'error');
                return;
            }

            const saveButton = e.submitter;
            saveButton.textContent = "Guardando...";
            saveButton.disabled = true;

            try {
                // 1. Obtener el siguiente valor de 'orden'
                const { data: maxOrder, error: orderError } = await client
                    .from('productos')
                    .select('orden')
                    .order('orden', { ascending: false })
                    .limit(1);

                if (orderError) throw new Error("Error al obtener orden: " + orderError.message);

                const newOrder = (maxOrder && maxOrder.length > 0) ? maxOrder[0].orden + 1 : 1;

                // 2. Subir archivos a Storage
                const uploadedImages = await uploadFiles(files, title);
                
                // 3. Insertar registro en la tabla 'productos'
                const { error: insertError } = await client
                    .from("productos")
                    .insert([{
                        titulo: title,
                        anio: year,
                        tecnica: technique,
                        medidas: size,
                        descripcion: description,
                        imagenes: uploadedImages, 
                        orden: newOrder,
                        
                        // CAMPOS NUEVOS EN LA BASE DE DATOS
                        categoria: category, 
                        serie: serie
                    }]);

                if (insertError) {
                    throw new Error("Error al insertar en DB: " + insertError.message);
                }

                showAlert("Obra guardada exitosamente!", 'success');
                obraForm.reset();
            } catch (error) {
                console.error(error);
                showAlert(error.message, 'error');
            } finally {
                saveButton.textContent = "Guardar obra";
                saveButton.disabled = false;
            }
        });
        
        // Inicializar
        checkAuth();
    </script>
</body>
</html>