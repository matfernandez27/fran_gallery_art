<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="config.js"></script> 
    
    <style>
        /* Estilos de Utilidad */
        #alert {
            position: fixed; top: 4px; left: 50%; transform: translateX(-50%);
            padding: 1rem; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            width: 90%; /* Ajuste para móviles */
            max-width: 400px; /* Ancho máximo para desktop */
        }
        .drag-handle {
            cursor: grab;
            transition: color 0.2s;
        }
        .drag-handle:hover {
            color: #DE3B89; /* Color de acento de tu web */
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #fce8f0; /* Color claro para indicar movimiento */
            border: 2px dashed #DE3B89;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 text-sm rounded-lg shadow-xl z-50" role="alert"></div>

    <header id="admin-header" class="bg-white shadow hidden">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
            <div class="flex space-x-4">
                <button id="add-obra-button" onclick="openForm()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    + Agregar Obra
                </button>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <div id="obra-form-container" class="bg-white p-6 rounded-lg shadow-xl mb-8 hidden">
            <h2 id="form-title" class="text-3xl font-light text-gray-800 mb-6 border-b pb-2">Nueva Obra</h2>
            <form id="obra-form" enctype="multipart/form-data">
                <input type="hidden" id="form-id" name="id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-gray-700">Título:</span>
                            <input type="text" id="form-titulo" name="titulo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-700">Año:</span>
                                <input type="number" id="form-anio" name="anio" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700">Categoría:</span>
                                <select id="form-categoria" name="categoria" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                                    <option value="grabado">Grabado</option>
                                    <option value="dibujo">Dibujo</option>
                                    <option value="pintura">Pintura</option>
                                    <option value="tecnica-mixta">Técnica Mixta</option>
                                </select>
                            </label>
                        </div>
                        <label class="block">
                            <span class="text-gray-700">Serie (Opcional):</span>
                            <input type="text" id="form-serie" name="serie" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </label>
                        <label class="block">
                            <span class="text-gray-700">Medidas (Ej: 50x70 cm):</span>
                            <input type="text" id="form-medidas" name="medidas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </label>
                        <label class="block">
                            <span class="text-gray-700">Descripción:</span>
                            <textarea id="form-descripcion" name="descripcion" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"></textarea>
                        </label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="form-disponible" name="disponible" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-gray-700">Disponible (Venta)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="form-destacada" name="destacada" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-gray-700">Destacada (Carrusel)</span>
                            </label>
                        </div>
                        <label class="block">
                            <span class="text-gray-700">Imagen Principal (URL Pública):</span>
                            <input type="url" id="form-imagen-principal" name="imagen_principal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </label>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-gray-700 font-semibold border-b pb-1">Imágenes Secundarias (Galería)</h3>
                        
                        <div id="existing-images-container" class="grid grid-cols-3 gap-4 border p-4 rounded-md bg-gray-50 hidden">
                            </div>

                        <label class="block">
                            <span class="text-gray-700">Subir Nuevas Imágenes (Múltiples):</span>
                            <input type="file" id="form-imagenes-secundarias" name="imagenes_secundarias" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pantone-magenta file:text-white hover:file:bg-opacity-90">
                        </label>

                        <div id="image-preview" class="flex flex-wrap gap-4 mt-2">
                            </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button type="button" onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" id="submit-button" class="bg-pantone-magenta hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Crear Obra
                    </button>
                </div>
            </form>
        </div>

        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Obras Publicadas</h2>
        
        <div id="sort-controls" class="mb-4 hidden">
             <button id="save-order-button" class="bg-pantone-magenta hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 hidden">
                Guardar Nuevo Orden
            </button>
            <p class="text-sm text-gray-600 mt-2">Arrastra los elementos para cambiar el orden de visualización en la web.</p>
        </div>

        <div id="works-list" class="space-y-4">
            </div>

        <div id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl mt-20 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Acceso de Administrador</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-gray-700">Email:</span>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </label>
                    <label class="block">
                        <span class="text-gray-700">Contraseña:</span>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </label>
                </div>
                <button type="submit" id="login-button" class="mt-6 w-full bg-pantone-magenta hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Acceder
                </button>
            </form>
        </div>
        
    </main>

    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="closeModal()">
        <div class="max-w-3xl max-h-[90%] p-4 bg-white rounded-lg relative" onclick="event.stopPropagation()">
            <button class="absolute top-2 right-2 text-white bg-black rounded-full p-2 hover:bg-gray-700" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <img id="modal-image" src="" alt="Vista previa de imagen" class="max-w-full max-h-full object-contain">
        </div>
    </div>


    <script>
        // --- CONFIGURACIÓN DE SUPABASE Y CONSTANTES ---
        const client = supabase.createClient(window.supabaseUrl, window.supabaseAnonKey);
        const TABLE_NAME = 'works';
        const BUCKET_NAME = 'obras';

        // --- VARIABLES GLOBALES ---
        let currentWorks = [];
        let formMode = 'create'; // 'create' o 'edit'
        let currentEditId = null;

        // --- UTILIDADES ---

        function showAlert(message, type = 'success') {
            const alertElement = document.getElementById('alert');
            alertElement.textContent = message;
            alertElement.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 text-sm rounded-lg shadow-xl z-50 ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} w-90 max-w-400`;
            alertElement.classList.remove('hidden');
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }

        function getPublicUrl(path) {
             return `${window.supabaseUrl}/storage/v1/object/public/${BUCKET_NAME}/${path}`;
        }
        
        function openModal(imagePath) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = getPublicUrl(imagePath);
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }
        
        // --- GESTIÓN DE AUTENTICACIÓN ---

        async function checkAuth() {
            const { data: { user } } = await client.auth.getUser();
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-header').classList.remove('hidden');
                loadWorks();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('admin-header').classList.add('hidden');
            }
        }
        
        document.getElementById('logout-button').addEventListener('click', async () => {
            const { error } = await client.auth.signOut();
            if (error) {
                showAlert("Error al cerrar sesión.", 'error');
            } else {
                window.location.reload();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginButton = document.getElementById('login-button');
            
            loginButton.textContent = 'Accediendo...';
            loginButton.disabled = true;

            const { error } = await client.auth.signInWithPassword({ email, password });

            if (error) {
                showAlert(`Error de acceso: ${error.message}`, 'error');
            } else {
                showAlert('¡Acceso exitoso! Recargando...', 'success');
                setTimeout(() => window.location.reload(), 1000);
            }
            loginButton.textContent = 'Acceder';
            loginButton.disabled = false;
        });


        // --- CARGA Y RENDERIZADO DE OBRAS ---

        async function loadWorks() {
            try {
                const { data, error } = await client.from(TABLE_NAME)
                    .select('*')
                    .order('position', { ascending: true }); // Ordenar por posición
                
                if (error) throw error;
                currentWorks = data;
                renderWorks(data);
                initSortable();

            } catch (error) {
                console.error("Error al cargar obras:", error);
                showAlert(`Error al cargar obras: ${error.message}`, 'error');
            }
        }

        function renderWorks(works) {
            const worksList = document.getElementById('works-list');
            worksList.innerHTML = '';

            works.forEach(obra => {
                const imagesCount = obra.imagenes ? obra.imagenes.length : 0;
                const imageUrl = obra.imagen_principal || (imagesCount > 0 ? getPublicUrl(obra.imagenes[0].path) : 'https://via.placeholder.com/150?text=No+Image');
                
                const obraItem = document.createElement('div');
                obraItem.id = `obra-item-${obra.id}`;
                obraItem.className = 'flex items-center bg-white p-4 rounded-lg shadow hover:shadow-lg transition duration-300';
                obraItem.innerHTML = `
                    <div class="drag-handle text-gray-400 p-2 mr-4 flex-shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </div>
                    <img src="${imageUrl}" alt="${obra.titulo}" class="w-20 h-20 object-cover rounded-md mr-4 flex-shrink-0" onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Error+Loading'">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800">${obra.titulo} (${obra.anio})</h3>
                        <p class="text-sm text-gray-600">${obra.categoria} ${obra.serie ? ` | Serie: ${obra.serie}` : ''}</p>
                        <div class="flex items-center text-xs space-x-2 mt-1">
                            ${obra.disponible ? '<span class="px-2 py-0.5 bg-green-200 text-green-800 rounded-full">Disponible</span>' : '<span class="px-2 py-0.5 bg-red-200 text-red-800 rounded-full">No Disponible</span>'}
                            ${obra.destacada ? '<span class="px-2 py-0.5 bg-pantone-magenta text-white rounded-full">Destacada</span>' : ''}
                            <span class="text-gray-500">${imagesCount} imagen(es)</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="editObra(${obra.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-100 transition duration-150" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-3l6-6m-6 6l-6-6M9 9l6-6"/>
                            </svg>
                        </button>
                        <button onclick="deleteObra(this, ${obra.id})" class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-100 transition duration-150" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                worksList.appendChild(obraItem);
            });
        }
        
        // --- GESTIÓN DE FORMULARIO ---

        function resetForm() {
            document.getElementById('obra-form').reset();
            document.getElementById('form-id').value = '';
            document.getElementById('form-titulo').focus();
            document.getElementById('form-title').textContent = 'Nueva Obra';
            document.getElementById('submit-button').textContent = 'Crear Obra';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('existing-images-container').innerHTML = '';
            document.getElementById('existing-images-container').classList.add('hidden');
            formMode = 'create';
            currentEditId = null;
        }

        function openForm(mode = 'create', id = null) {
            document.getElementById('obra-form-container').classList.remove('hidden');
            document.getElementById('works-list').classList.add('hidden');
            document.getElementById('sort-controls').classList.add('hidden');
            resetForm(); 

            if (mode === 'edit' && id !== null) {
                formMode = 'edit';
                currentEditId = id;
                const obra = currentWorks.find(w => w.id === id);
                if (!obra) {
                    showAlert('Error: Obra no encontrada para editar.', 'error');
                    return;
                }

                // Llenar campos
                document.getElementById('form-id').value = obra.id;
                document.getElementById('form-titulo').value = obra.titulo;
                document.getElementById('form-anio').value = obra.anio;
                document.getElementById('form-categoria').value = obra.categoria;
                document.getElementById('form-serie').value = obra.serie || '';
                document.getElementById('form-medidas').value = obra.medidas || '';
                document.getElementById('form-descripcion').value = obra.descripcion || '';
                document.getElementById('form-disponible').checked = obra.disponible;
                document.getElementById('form-destacada').checked = obra.destacada;
                document.getElementById('form-imagen-principal').value = obra.imagen_principal || '';
                
                document.getElementById('form-title').textContent = `Editar Obra: ${obra.titulo}`;
                document.getElementById('submit-button').textContent = 'Guardar Cambios';

                // Mostrar imágenes existentes
                renderExistingImages(obra);
            }
        }
        
        function renderExistingImages(obra) {
            const container = document.getElementById('existing-images-container');
            container.innerHTML = '';
            
            const allImages = [
                ...(obra.imagen_principal ? [{ path: obra.imagen_principal_path, is_main: true, id: 'main-img' }] : []),
                ...(obra.imagenes || [])
            ].filter(img => img && img.path); 

            if (allImages.length === 0) {
                 container.classList.add('hidden');
                 return;
            }

            container.classList.remove('hidden');
            
            allImages.forEach(img => {
                const isMain = img.id === 'main-img';
                const imgPath = img.path; 
                
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative group';
                imgDiv.innerHTML = `
                    <img src="${getPublicUrl(imgPath)}" alt="Imagen" class="w-full h-20 object-cover rounded-md cursor-pointer" onclick="openModal('${imgPath}')">
                    
                    <button type="button" 
                            onclick="deleteImage(this, '${obra.id}', '${imgPath}', ${isMain})" 
                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition duration-300"
                            title="Eliminar ${isMain ? 'Principal' : 'Secundaria'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    ${isMain ? '<span class="absolute bottom-1 left-1 px-2 py-0.5 text-xs bg-pantone-magenta text-white rounded-full">Principal</span>' : ''}
                `;
                container.appendChild(imgDiv);
            });
        }
        
        async function deleteImage(button, obraId, imagePath, isMain) {
            if (!confirm(`¿Estás seguro de eliminar esta imagen? ${isMain ? '(Es la imagen principal)' : ''}`)) return;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            button.disabled = true;

            try {
                const obra = currentWorks.find(w => w.id === parseInt(obraId));
                if (!obra) throw new Error("Obra no encontrada.");

                // 1. Eliminar del Storage
                const { error: storageError } = await client.storage.from(BUCKET_NAME).remove([imagePath]);

                if (storageError && storageError.statusCode !== '200') {
                    console.warn("Error al borrar imagen del storage:", storageError);
                    showAlert("Advertencia: Falló el borrado del archivo del Storage. Intente manualmente.", 'error');
                }

                // 2. Actualizar la base de datos (Eliminar la referencia)
                let updateData = {};
                
                if (isMain) {
                    // Si es la imagen principal, se borra el path principal
                    updateData = { imagen_principal: null, imagen_principal_path: null };
                } else {
                    // Si es secundaria, se filtra del array de `imagenes`
                    const newImages = (obra.imagenes || []).filter(img => img.path !== imagePath);
                    updateData = { imagenes: newImages };
                }

                const { error: dbError, data: updatedData } = await client.from(TABLE_NAME)
                    .update(updateData)
                    .eq('id', obraId)
                    .select();

                if (dbError) throw dbError;

                // 3. Actualizar array local y DOM
                if (updatedData && updatedData.length > 0) {
                    const index = currentWorks.findIndex(w => w.id === parseInt(obraId));
                    if (index !== -1) {
                        currentWorks[index] = updatedData[0];
                    }
                }
                
                renderExistingImages(currentWorks.find(w => w.id === parseInt(obraId)));
                showAlert(`Imagen eliminada exitosamente.`, 'success');

            } catch (error) {
                console.error(error);
                showAlert(`Error al eliminar imagen: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Función para previsualizar los archivos de entrada antes de subir
        document.getElementById('form-imagenes-secundarias').addEventListener('change', (event) => {
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = ''; 
            const files = event.target.files;

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-16 h-16 object-cover rounded-md border border-gray-300';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });


        document.getElementById('obra-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('submit-button');
            const originalText = submitButton.textContent;
            
            submitButton.textContent = formMode === 'create' ? 'Creando...' : 'Guardando...';
            submitButton.disabled = true;

            try {
                const formData = new FormData(form);
                const id = formData.get('id');
                const isEdit = formMode === 'edit' && id;
                const obraActual = isEdit ? currentWorks.find(w => w.id === parseInt(id)) : null;

                let dataToInsert = {
                    titulo: formData.get('titulo'),
                    anio: parseInt(formData.get('anio')),
                    categoria: formData.get('categoria'),
                    serie: formData.get('serie') || null,
                    medidas: formData.get('medidas') || null,
                    descripcion: formData.get('descripcion') || null,
                    disponible: formData.get('disponible') === 'on',
                    destacada: formData.get('destacada') === 'on',
                    imagen_principal: formData.get('imagen_principal') || null,
                    imagenes: isEdit ? obraActual.imagenes : [] 
                };
                
                // 1. Manejo de archivos de la Galería (Secundarias)
                const newFiles = formData.get('imagenes_secundarias').files;
                let newImagePaths = [];

                if (newFiles && newFiles.length > 0) {
                    const uploadPromises = Array.from(newFiles).map(file => {
                        // Generar un path único
                        const fileName = `${Date.now()}-${file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase()}`;
                        const filePath = `secundarias/${fileName}`;
                        
                        return client.storage.from(BUCKET_NAME).upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        }).then(({ data, error }) => {
                            if (error) throw error;
                            return { 
                                path: data.path, // Esto es 'secundarias/nombre-archivo.jpg'
                                alt: file.name 
                            };
                        });
                    });
                    
                    const uploadedImages = await Promise.all(uploadPromises);
                    newImagePaths = uploadedImages;
                    
                    // Fusionar con las imágenes existentes en modo edición
                    dataToInsert.imagenes = [...dataToInsert.imagenes, ...newImagePaths];
                }
                
                
                // 2. Manejo de la Imagen Principal (Si se proporciona una URL o si se actualiza a nulo)
                const newMainUrl = formData.get('imagen_principal');
                
                if (isEdit) {
                    // Si se estaba editando, mantener el path de la principal
                    dataToInsert.imagen_principal_path = obraActual.imagen_principal_path; 
                }
                
                if (newMainUrl && newMainUrl !== (obraActual?.imagen_principal || '')) {
                    // Si se ha cambiado la URL de la principal:
                    // 2a. Si había un archivo anterior en Storage, no lo eliminamos aquí, se debería hacer con el botón de borrar imagen.
                    // 2b. Establecer los nuevos valores
                    dataToInsert.imagen_principal = newMainUrl;
                    dataToInsert.imagen_principal_path = null; // Asumimos que si es una URL externa, no tiene path en Storage
                }
                
                // 3. Insertar o Actualizar en la Base de Datos
                let result;
                if (isEdit) {
                    result = await client.from(TABLE_NAME)
                        .update(dataToInsert)
                        .eq('id', id)
                        .select();
                } else {
                    // En modo creación, primero obtener el 'position' para el nuevo elemento (al final)
                    const newPosition = currentWorks.length > 0 ? currentWorks[currentWorks.length - 1].position + 1 : 1;
                    dataToInsert.position = newPosition;
                    result = await client.from(TABLE_NAME)
                        .insert([dataToInsert])
                        .select();
                }
                
                if (result.error) throw result.error;

                showAlert(`Obra ${isEdit ? 'actualizada' : 'creada'} exitosamente!`, 'success');
                
                // Cerrar formulario y recargar
                document.getElementById('obra-form-container').classList.add('hidden');
                document.getElementById('works-list').classList.remove('hidden');
                document.getElementById('sort-controls').classList.remove('hidden');
                resetForm();
                loadWorks(); 

            } catch (error) {
                console.error("Error al procesar el formulario:", error);
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });


        // --- GESTIÓN DE BORRADO ---

        async function deleteObra(button, id) {
            if (!confirm("¿Estás seguro de que quieres eliminar esta obra? Esto es irreversible y borrará todos los archivos asociados.")) return;

            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            button.disabled = true;

            try {
                const obra = currentWorks.find(w => w.id === id);
                if (!obra) throw new Error("Obra no encontrada localmente.");

                // 1. Eliminar de la base de datos
                const { error: dbError } = await client.from(TABLE_NAME)
                    .delete()
                    .eq('id', id);

                if (dbError) throw dbError;

                // 2. Identificar y eliminar archivos del Storage
                // Obtener paths de imágenes secundarias y el path de la imagen principal (si existe y está en Storage)
                const secondaryPaths = (obra.imagenes || []).map(img => img.path).filter(Boolean);
                
                let filePaths = [...secondaryPaths];

                // Si la imagen principal tiene un path en Storage (no es una URL externa)
                if (obra.imagen_principal_path) {
                    filePaths.push(obra.imagen_principal_path);
                }
                
                if (filePaths.length > 0) {
                    const { error: storageError } = await client.storage
                        .from(BUCKET_NAME)
                        .remove(filePaths);

                    if (storageError && storageError.statusCode !== '200') {
                        console.warn("Error al borrar imágenes del storage:", storageError);
                        // Emitir advertencia pero continuar, ya que la obra fue eliminada de la DB
                        showAlert(`Obra eliminada de la DB. ADVERTENCIA: Falló el borrado de ${filePaths.length} imagen(es) del Storage.`, 'error');
                        return; 
                    }
                }

                // 3. Éxito
                showAlert("Obra y archivos eliminados exitosamente!", 'success');
                // Remover el elemento del DOM inmediatamente
                document.getElementById(`obra-item-${id}`).remove(); 
                
                // Remover del array local
                currentWorks = currentWorks.filter(w => w.id !== id);

            } catch (error) {
                console.error(error);
                showAlert(error.message, 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // --- GESTIÓN DE ORDENAMIENTO (DRAG & DROP) ---

        function initSortable() {
            const el = document.getElementById('works-list');
            const saveOrderButton = document.getElementById('save-order-button');
            document.getElementById('sort-controls').classList.remove('hidden');

            new Sortable(el, {
                animation: 150,
                handle: '.drag-handle', // Solo se puede arrastrar por el handle
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        saveOrderButton.classList.remove('hidden');
                    }
                },
            });
        }
        
        document.getElementById('save-order-button').addEventListener('click', async () => {
            const saveOrderButton = document.getElementById('save-order-button');
            saveOrderButton.textContent = "Guardando...";
            saveOrderButton.disabled = true;

            try {
                const worksList = document.getElementById('works-list');
                const listItems = Array.from(worksList.children);
                
                // Crear el nuevo orden con ID y nueva posición
                const newOrder = listItems.map((item, index) => {
                    const idMatch = item.id.match(/obra-item-(\d+)/);
                    return {
                        id: parseInt(idMatch[1]),
                        position: index + 1
                    };
                });

                // Crear promesas de actualización
                const updatePromises = newOrder.map(item => 
                    client.from(TABLE_NAME).update({ position: item.position }).eq('id', item.id)
                );
                
                const results = await Promise.all(updatePromises);
                
                // Verificar si alguna promesa falló
                const failed = results.some(r => r.error);
                if (failed) throw new Error('Falló la actualización de una o más posiciones.');

                showAlert("Orden actualizado exitosamente!", 'success');
                saveOrderButton.classList.add('hidden');
                
                // Actualizar el array local para mantener la consistencia
                currentWorks.forEach(work => {
                    const newPos = newOrder.find(item => item.id === work.id)?.position;
                    if (newPos !== undefined) {
                        work.position = newPos;
                    }
                });
                currentWorks = currentWorks.sort((a, b) => a.position - b.position);

            } catch (error) {
                console.error("Error al guardar el orden:", error);
                showAlert("Error al guardar el orden. Intente nuevamente.", 'error');
            } finally {
                saveOrderButton.textContent = "Guardar Nuevo Orden";
                saveOrderButton.disabled = false;
            }
        });


        // --- FUNCIONES ACCESIBLES GLOBALMENTE (para onclick) ---
        window.editObra = (id) => openForm('edit', id);
        window.deleteObra = deleteObra;
        window.deleteImage = deleteImage;
        window.closeModal = closeModal;
        window.openForm = openForm;
        window.resetForm = resetForm;
        window.getPublicUrl = getPublicUrl;
        window.openModal = openModal;


        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>