<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Francisco Fernández | Galería de Arte Patagónico, Dibujo y Grabado Contemporáneo</title>
    
    <meta name="description" content="Galería oficial de Francisco Fernández. Descubre obras de arte patagónico, grabados, dibujos y pintura que exploran la dualidad entre lo ancestral y lo moderno.">

    <meta property="og:title" content="Francisco Fernández - Arte Patagónico y Grabado Contemporáneo">
    <meta property="og:description" content="Descubre la Galería Personal de Francisco Fernández: un diálogo visual entre la inmensidad de la Patagonia y la experiencia urbana moderna.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fran-faf.vercel.app/">
    <meta property="og:image" content="[URL_IMAGEN_DESTACADA]"> 
    <meta property="og:locale" content="es_AR">
    <link rel="icon" type="image/png" href="./img/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="config.js"></script>

    <script>
        // Configuración de colores personalizados (VIVO Y CLARO)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pantone-magenta': '#DE3B89',
                        'bg-principal': '#FAEBF0',
                        'bg-card': '#FFFFFF',
                        'text-dark': '#333333',
                        'text-muted': '#666666',
                        'border-light': '#E0E0E0',
                        'whatsapp': '#25D366',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <style>
        /* Estilos de Utilidad */
        .swiper-button-prev, .swiper-button-next {
            color: #DE3B89 !important;
        }
        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease-in-out;
            pointer-events: none; 
        }
        .whatsapp-button.show {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }
        /* Clase para evitar que el scroll se rompa al abrir el modal */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-bg-principal text-text-dark font-sans min-h-screen">

    <header class="bg-bg-principal fixed top-0 w-full z-20 border-b border-border-light shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="./index.html" class="flex-shrink-0 font-bold text-lg text-pantone-magenta">
                    Francisco Fernández
                </a>
                <nav class="flex space-x-6 text-sm font-medium">
                    <a href="./index.html#gallery-section" class="text-text-dark hover:text-pantone-magenta transition duration-150">Galería</a>
                    <a href="./biografia-completa.html" class="text-text-dark hover:text-pantone-magenta transition duration-150">Biografía</a>
                    <a href="mailto:tuemail@dominio.com" class="text-text-dark hover:text-pantone-magenta transition duration-150 hidden sm:inline-block">Contacto</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-16">
        
        <section id="carousel-section" class="pt-10 pb-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 id="carousel-header" class="text-2xl font-bold mb-8 text-center text-text-dark">Obras Destacadas</h2>
                
                <div class="swiper mySwiper">
                    <div id="carousel-items" class="swiper-wrapper">
                        </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
            </div>
        </section>


        <section id="gallery-section" class="py-16 bg-bg-card shadow-inner">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold mb-10 text-center text-text-dark">Catálogo Completo</h2>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <input type="text" id="search-input" placeholder="Buscar por Título o Técnica..." 
                           class="col-span-1 md:col-span-2 p-2 border border-border-light rounded-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                    
                    <select id="filter-year" class="p-2 border border-border-light rounded-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todos los Años</option>
                    </select>
                    <select id="filter-category" class="p-2 border border-border-light rounded-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todas las Categorías</option>
                    </select>
                    <select id="filter-series" class="p-2 border border-border-light rounded-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todas las Series</option>
                    </select>
                </div>

                <div id="gallery-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <p id="loading-gallery" class="col-span-full text-center text-text-muted">Cargando obras...</p>
                    </div>
                
                <p id="no-results" class="col-span-full text-center text-text-muted mt-10 hidden">No se encontraron obras con los filtros seleccionados.</p>
            </div>
        </section>
        
    </main>

    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full flex flex-col md:flex-row max-h-[95vh]" onclick="event.stopPropagation()">
            
            <div class="w-full md:w-1/2 relative bg-gray-100 p-4">
                <div class="swiper mySwiperModal h-full">
                    <div id="modal-image-carousel" class="swiper-wrapper">
                        </div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 overflow-y-auto">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-text-dark hover:text-pantone-magenta z-10">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <h3 id="modal-titulo" class="text-3xl font-bold text-text-dark mb-2"></h3>
                <p id="modal-tecnica-anio" class="text-lg text-text-muted mb-4"></p>
                
                <hr class="my-4 border-border-light">

                <div class="space-y-2 text-sm">
                    <p><span class="font-semibold">Categoría:</span> <span id="modal-categoria"></span></p>
                    <p><span class="font-semibold">Medidas:</span> <span id="modal-medidas"></span></p>
                    <p><span class="font-semibold">Serie:</span> <span id="modal-serie"></span></p>
                </div>

                <hr class="my-4 border-border-light">

                <p id="modal-descripcion" class="text-text-dark leading-relaxed mb-6"></p>

                <div id="modal-price-status" class="mt-auto pt-4 border-t border-border-light">
                    </div>

            </div>
        </div>
    </div>
    
    <footer id="main-footer" class="fixed bottom-0 w-full bg-pantone-magenta text-white py-4 z-10 transition-transform duration-500 ease-out">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-center space-x-8 text-sm">
            <p>&copy; <span id="current-year"></span> Francisco Fernández. Todos los derechos reservados.</p>
            <a href="./biografia-completa.html" class="hover:underline">Términos y Condiciones</a>
        </div>
    </footer>

    <a href="https://wa.me/5491100000000?text=Hola%2C%20estoy%20interesado%20en%20una%20obra." target="_blank" class="whatsapp-button bg-whatsapp text-white p-4 rounded-full shadow-lg hover:bg-opacity-90 transition duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 16.29c-1.3-3.6 1.45-7.7 5.75-9.3 4.3-1.6 8.9 1.2 10.2 4.8s-1.4 7.7-5.7 9.3c-4.3 1.6-8.9-1.2-10.2-4.8zM19.1 4.9c-.9-.9-2.1-1.3-3.4-1.3-1.3 0-2.5.4-3.4 1.3L4.9 11.4c-.9.9-1.3 2.1-1.3 3.4 0 1.3.4 2.5 1.3 3.4l8.1-8.1 3.4-3.4zM20 12c0 4.4-3.6 8-8 8s-8-3.6-8-8 3.6-8 8-8 8 3.6 8 8z"/></svg>
    </a>


    <script>
        /* global supabase, window, Swiper */ 

        // --- CONFIGURACIÓN DE SUPABASE ---
        const supabaseUrl = window.supabaseUrl;
        const supabaseAnonKey = window.supabaseAnonKey;
        const client = supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // CORRECCIÓN: Usar la tabla 'productos' para la galería
        const TABLE_NAME = 'productos'; 
        const BUCKET_NAME = 'imagenes'; 

        // --- VARIABLES GLOBALES ---
        let allWorks = []; // Almacena todas las obras cargadas
        let availableYears = new Set();
        let availableCategories = new Set();
        let availableSeries = new Set();

        // --- REFERENCIAS DOM ---
        const galleryContainer = document.getElementById('gallery-container');
        const loadingGallery = document.getElementById('loading-gallery');
        const noResults = document.getElementById('no-results');
        const detailsModal = document.getElementById('details-modal');
        const modalImageCarousel = document.getElementById('modal-image-carousel');
        const filterYear = document.getElementById('filter-year');
        const filterCategory = document.getElementById('filter-category');
        const filterSeries = document.getElementById('filter-series');
        const searchInput = document.getElementById('search-input');
        const carouselItems = document.getElementById('carousel-items');
        
        // --- UTILIDADES ---

        function getPublicUrl(path) {
            const { data } = client.storage.from(BUCKET_NAME).getPublicUrl(path);
            return data.publicUrl;
        }

        function formatPrice(price) {
            if (price === null) return 'Consultar precio';
            return price.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
        }

        // --- LÓGICA DE DATOS Y CARGA ---

        async function loadWorks() {
            loadingGallery.classList.remove('hidden');
            galleryContainer.innerHTML = ''; 

            try {
                // CORRECCIÓN: Carga desde TABLE_NAME ('productos')
                const { data, error } = await client
                    .from(TABLE_NAME) 
                    .select("*")
                    .order("orden", { ascending: true }) // Ordenamiento por el campo de arrastre
                    .order("anio", { ascending: false });

                if (error) throw error;
                
                allWorks = data;
                
                renderFilterOptions(data);
                applyFilters(); // Mostrar la galería inicial
                renderCarouselItems(data);
                
            } catch (error) {
                console.error("Error al cargar las obras:", error);
                loadingGallery.textContent = `Error al cargar: ${error.message}`;
            } finally {
                loadingGallery.classList.add('hidden');
            }
        }

        // --- RENDERIZADO Y FILTROS ---

        function renderFilterOptions(works) {
            availableYears.clear();
            availableCategories.clear();
            availableSeries.clear();

            works.forEach(w => {
                if (w.anio) availableYears.add(w.anio.toString());
                if (w.categoria) availableCategories.add(w.categoria);
                if (w.serie) availableSeries.add(w.serie);
            });

            // Llenar Años (orden descendente)
            [...availableYears].sort((a, b) => b - a).forEach(year => {
                filterYear.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // Llenar Categorías
            [...availableCategories].sort().forEach(category => {
                filterCategory.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            // Llenar Series
            [...availableSeries].sort().forEach(series => {
                filterSeries.innerHTML += `<option value="${series}">${series}</option>`;
            });
        }

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const yearFilter = filterYear.value;
            const categoryFilter = filterCategory.value;
            const seriesFilter = filterSeries.value;

            const filteredWorks = allWorks.filter(w => {
                const matchesSearch = searchTerm === '' || 
                                      w.titulo.toLowerCase().includes(searchTerm) || 
                                      w.tecnica.toLowerCase().includes(searchTerm);
                
                const matchesYear = yearFilter === '' || w.anio.toString() === yearFilter;
                const matchesCategory = categoryFilter === '' || w.categoria === categoryFilter;
                const matchesSeries = seriesFilter === '' || w.serie === seriesFilter;

                // Solo mostrar obras que tengan imágenes y estén disponibles
                const isDisplayable = w.imagenes && w.imagenes.length > 0 && w.is_available;
                
                return matchesSearch && matchesYear && matchesCategory && matchesSeries && isDisplayable;
            });
            
            renderGallery(filteredWorks);
        }
        
        function renderGallery(works) {
            galleryContainer.innerHTML = '';
            noResults.classList.add('hidden');

            if (works.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }

            works.forEach(obra => {
                const mainImage = obra.imagenes[0];
                galleryContainer.innerHTML += `
                    <div onclick="openModal('${obra.id}')" class="bg-bg-card rounded-sm shadow-md hover:shadow-xl transition duration-300 transform hover:-translate-y-0.5 cursor-pointer overflow-hidden">
                        <div class="h-60 overflow-hidden">
                            <img src="${getPublicUrl(mainImage.path)}" alt="${obra.titulo}" 
                                 class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                                 onerror="this.onerror=null;this.src='./img/placeholder.jpg';">
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-text-dark truncate">${obra.titulo}</h4>
                            <p class="text-sm text-text-muted">${obra.tecnica} (${obra.anio})</p>
                            <p class="mt-2 text-pantone-magenta font-bold text-sm">
                                ${obra.show_price ? formatPrice(obra.price) : 'Consultar Precio'}
                            </p>
                        </div>
                    </div>
                `;
            });
        }

        // --- CARRUSEL (HOME) ---
        
        let swiperInstance = null;
        
        function renderCarouselItems(works) {
            const carouselWorks = works.filter(w => w.es_carrusel && w.is_available && w.imagenes && w.imagenes.length > 0);
            carouselItems.innerHTML = '';
            
            if (carouselWorks.length === 0) {
                document.getElementById('carousel-header').classList.add('hidden');
                return;
            }
            
            document.getElementById('carousel-header').classList.remove('hidden');
            
            carouselWorks.forEach(obra => {
                const mainImage = obra.imagenes[0];
                carouselItems.innerHTML += `
                    <div class="swiper-slide bg-bg-card rounded-lg shadow-lg overflow-hidden cursor-pointer" onclick="openModal('${obra.id}')">
                        <div class="h-96 w-full relative">
                            <img src="${getPublicUrl(mainImage.path)}" alt="${obra.titulo}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-30 flex items-end p-6">
                                <h3 class="text-white text-2xl font-bold">${obra.titulo}</h3>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Inicializar Swiper después de cargar los elementos
            if (swiperInstance) {
                swiperInstance.destroy();
            }
            swiperInstance = new Swiper(".mySwiper", {
                slidesPerView: 1,
                spaceBetween: 30,
                loop: true,
                autoplay: {
                    delay: 4500,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
                breakpoints: {
                    768: {
                        slidesPerView: 2,
                        spaceBetween: 40,
                    },
                    1024: {
                        slidesPerView: 3,
                        spaceBetween: 50,
                    },
                },
            });
        }

        // --- MODAL DE DETALLES ---

        let swiperModalInstance = null;

        function openModal(id) {
            const obra = allWorks.find(w => w.id === id);
            if (!obra) return;
            
            // Llenar detalles de la obra
            document.getElementById('modal-titulo').textContent = obra.titulo || 'Sin Título';
            document.getElementById('modal-tecnica-anio').textContent = `${obra.tecnica || 'Técnica no especificada'} (${obra.anio || 'N/A'})`;
            document.getElementById('modal-categoria').textContent = obra.categoria || 'N/A';
            document.getElementById('modal-medidas').textContent = obra.medidas || 'N/A';
            document.getElementById('modal-serie').textContent = obra.serie || 'N/A';
            document.getElementById('modal-descripcion').textContent = obra.descripcion || 'Sin descripción.';

            // Llenar estado y precio
            const priceStatusDiv = document.getElementById('modal-price-status');
            const availabilityText = obra.is_available ? '<span class="text-green-600 font-semibold">Disponible</span>' : '<span class="text-red-600 font-semibold">Vendido</span>';
            const priceText = obra.show_price ? `<p class="text-2xl font-bold text-pantone-magenta mt-2">${formatPrice(obra.price)}</p>` : `<p class="text-lg font-bold text-pantone-magenta mt-2">Consultar Precio</p>`;
            
            priceStatusDiv.innerHTML = `
                <p class="text-sm mb-1">Estado: ${availabilityText}</p>
                ${priceText}
                <a href="https://wa.me/5491100000000?text=Hola%2C%20me%20interesa%20la%20obra%3A%20${encodeURIComponent(obra.titulo)}" target="_blank" class="mt-4 inline-block bg-whatsapp hover:bg-opacity-90 text-white font-bold py-3 px-6 rounded-sm transition duration-300">
                    Consultar por WhatsApp
                </a>
            `;


            // Llenar carrusel de imágenes
            modalImageCarousel.innerHTML = '';
            obra.imagenes.forEach(img => {
                modalImageCarousel.innerHTML += `
                    <div class="swiper-slide h-full flex items-center justify-center">
                        <img src="${getPublicUrl(img.path)}" alt="${obra.titulo}" class="max-h-full max-w-full object-contain">
                    </div>
                `;
            });

            // Mostrar el modal
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');
            document.body.classList.add('modal-open');

            // Destruir e inicializar Swiper del modal
            if (swiperModalInstance) {
                swiperModalInstance.destroy();
            }
            swiperModalInstance = new Swiper(".mySwiperModal", {
                slidesPerView: 1,
                spaceBetween: 10,
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                loop: false,
            });
            // Es necesario forzar el update después de mostrarlo si el modal estaba oculto
            setTimeout(() => swiperModalInstance.update(), 100); 
        }

        function closeModal() {
            detailsModal.classList.add('hidden');
            detailsModal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }
        
        // --- LOGICA DE FOOTER Y WHATSAPP ---
        
        const mainFooter = document.getElementById('main-footer');
        const whatsappButton = document.querySelector('.whatsapp-button');
        const firstSection = document.getElementById('carousel-header') ? document.getElementById('carousel-section') : null;
        const gallerySection = document.getElementById('gallery-section'); 
        document.getElementById('current-year').textContent = new Date().getFullYear();

        window.addEventListener('scroll', () => {
            if (!firstSection) return;
            
            const firstSectionHeight = firstSection.offsetHeight;
            
            // Lógica del Footer
            if (window.scrollY > firstSectionHeight - 100) { 
                mainFooter.classList.remove('translate-y-full');
            } else {
                mainFooter.classList.add('translate-y-full');
            }

            // Lógica del Botón de WhatsApp
            const gallerySectionTop = gallerySection ? gallerySection.offsetTop : firstSectionHeight;
            if (window.scrollY > gallerySectionTop - window.innerHeight / 2) { 
                whatsappButton.classList.add('show');
            } else {
                whatsappButton.classList.remove('show');
            }
        });

        // --- FUNCIONES ACCESIBLES GLOBALMENTE ---
        window.openModal = openModal;
        window.closeModal = closeModal;


        // Inicializar la Galería y Auth (CORRECCIÓN FINAL: Bloque movido al final del script)
        document.addEventListener('DOMContentLoaded', () => {
            // Ocultar elementos al cargar para una transición suave
            mainFooter.classList.add('translate-y-full');
            whatsappButton.classList.remove('show');
            
            // Cargar datos
            loadWorks(); 
        });

        // Event Listeners de Filtro
        searchInput.addEventListener("input", applyFilters);
        filterYear.addEventListener("change", applyFilters);
        filterCategory.addEventListener("change", applyFilters);
        
        // El listener de filterSeries se adjunta de forma segura aquí
        if (filterSeries) {
            filterSeries.addEventListener("change", applyFilters);
        }

    </script>
</body>
</html>