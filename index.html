<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Francisco Fernández | Galería de Arte Patagónico, Dibujo y Grabado Contemporáneo</title>
    
    <meta name="description" content="Galería oficial de Francisco Fernández. Descubre obras de arte patagónico, grabados, dibujos y pintura que exploran la dualidad entre lo ancestral y lo moderno.">

    <meta property="og:title" content="Francisco Fernández - Arte Patagónico y Grabado Contemporáneo">
    <meta property="og:description" content="Descubre la Galería Personal de Francisco Fernández: un diálogo visual entre la inmensidad de la Patagonia y la experiencia urbana moderna.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fran-faf.vercel.app/">
    <meta property="og:image" content="[URL_IMAGEN_DESTACADA]"> 
    <meta property="og:locale" content="es_AR">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de colores personalizados (VIVO Y CLARO)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pantone-magenta': '#DE3B89', // PANTONE 17-2036 TPG/TCX (Acento)
                        'bg-principal': '#FAEBF0',    // Fondo Principal (Magenta muy pálido)
                        'bg-card': '#FFFFFF',         // Fondo de Tarjetas/Secciones (Blanco puro)
                        'text-dark': '#333333',       // Texto principal (Gris oscuro)
                        'text-muted': '#666666',      // Texto secundario (Gris medio)
                        'border-light': '#E0E0E0',    // Bordes y líneas divisorias (Gris claro)
                        'whatsapp': '#25D366',        // Verde de WhatsApp
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        /* Estilos del Overlay de Carga (Spinner) */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(250, 235, 240, 0.95); /* bg-principal con opacidad */
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        /* Color del spinner ajustado al PANTONE Magenta */
        .lds-ring div { 
            box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; 
            border: 8px solid #DE3B89; /* pantone-magenta */
            border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; 
            border-color: #DE3B89 transparent transparent transparent; /* pantone-magenta */
        }
        
        /* Estilo del Botón Flotante de WhatsApp (MANTENIDO) */
        .whatsapp-float-btn {
            position: fixed; bottom: 60px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            z-index: 50; transition: transform 0.3s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0; 
            pointer-events: none; 
        }
        .whatsapp-float-btn.show { opacity: 1; pointer-events: auto; }
        .whatsapp-float-btn:hover { transform: scale(1.1); }

        /* --- ESTILOS DE ZOOM INTERACTIVO (MANTENIDOS) --- */
        .zoom-container {
            position: relative; overflow: hidden; cursor: crosshair; 
        }
        .zoom-image {
            width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s ease-in-out; 
            transform: scale(1); transform-origin: center center;
        }
        .zoom-container:hover .zoom-image { transform: scale(2.5); }
        .zoom-icon {
            position: absolute; top: 10px; left: 10px;
            /* Ícono oscuro sobre fondo blanco de la imagen */
            background: rgba(255, 255, 255, 0.5); color: #333333; 
            padding: 8px; border-radius: 50%; z-index: 10;
            border: 1px solid #E0E0E0;
        }

        /* Estilo para el modo de ordenamiento (color de fantasma ajustado) */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #DE3B89; /* pantone-magenta para el fantasma */
            border: 2px dashed #333333; /* texto-dark para el borde */
        }

        /* Estilo para el footer con degradado (ajustado para la nueva paleta) */
        .footer-gradient {
            /* Degradado de un tono de magenta claro a blanco */
            background: linear-gradient(to right, #F5E5EC, #FFFFFF); 
        }

        /* Estilo de alerta flotante */
        #alert {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1001; /* Más alto que el modal */
            padding: 1rem; border-radius: 0.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-bg-principal text-text-dark font-sans min-h-screen">
    
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
    </div>

    <div id="alert" class="hidden" role="alert"></div>

    <a id="whatsapp-btn" href="https://wa.me/+5492805032663?text=Hola,%20quisiera%20consultar%20sobre%20una%20obra%20de%20la%20galería." 
        target="_blank" 
        class="whatsapp-float-btn bg-whatsapp text-white">
        <svg fill="#FFF" viewBox="0 0 24 24" width="28" height="28" class="whatsapp-icon"><path d="M12 2C6.48 2 2 6.48 2 12c0 3.25 1.5 6.2 3.88 8.1l-1.38 5.02L7.6 21.62C9.5 22.18 11.08 22 12 22c5.52 0 10-4.48 10-10C22 6.48 17.52 2 12 2zM17.43 15.4c-.09-.15-.36-.24-.77-.42-.42-.18-2.52-1.24-2.91-1.38-.39-.14-.67-.21-.95.21-.28.42-1.09 1.38-1.34 1.66-.25.28-.5.31-.92.21-.42-.1-.71-.34-1.27-.64-.47-.25-1.07-.65-2.03-1.89-.75-.98-1.25-1.95-1.38-2.2-.14-.25-.02-.38.11-.5.1-.11.23-.26.35-.4.12-.14.16-.25.25-.42.09-.17.04-.32-.02-.45-.06-.13-.57-1.36-.78-1.87-.2-.5-.41-.42-.56-.42-.15 0-.33-.02-.51-.02-.18 0-.47.07-.72.35-.25.28-.95.93-.95 2.27 0 1.34.97 2.64 1.1 2.82.13.18 1.92 3.03 4.6 4.24 2.68 1.21 2.68.85 2.97.8.29-.05.95-.39 1.08-.77.13-.38.13-.7.09-.77z"/></svg>
    </a>

    <section class="min-h-screen flex items-center justify-center bg-bg-principal">
        <div class="text-center max-w-4xl mx-auto px-6">
            <h1 class="text-6xl md:text-8xl font-light text-text-dark mb-8 tracking-tight">
                Francisco<br>
                <span class="text-pantone-magenta">Fernández</span>
            </h1>
            <p class="text-xl md:text-2xl text-text-muted font-light mb-12 max-w-2xl mx-auto">
                Galería Personal
            </p>
            <div class="w-24 h-px bg-pantone-magenta mx-auto mb-12"></div>
            <button onclick="document.getElementById('bio-section').scrollIntoView({behavior: 'smooth'})" 
                    class="text-text-muted hover:text-pantone-magenta transition-colors duration-300 text-sm uppercase tracking-wider">
                Explorar Galería
            </button>
        </div>
    </section>

    <section id="bio-section" class="py-20 bg-bg-card">
        <div class="max-w-6xl mx-auto px-6">
            <div class="grid md:grid-cols-2 gap-16 items-center">
                <div>
                    <div class="w-16 h-px bg-pantone-magenta mb-8"></div>
                    
                    <h3 class="text-2xl font-medium text-text-dark mb-6">Francisco Fernández</h3>
                    
                    <p class="text-lg text-text-dark leading-relaxed mb-6">
                        Nacido en Trelew, Chubut hace 33 años y residente en la Patagonia, Francisco Fernández se destaca por su activa participación en exhibiciones itinerantes a lo largo del país.
                    </p>
                    
                    <p class="text-base text-text-muted leading-relaxed mb-6">
                        <strong>Su obra explora con maestría la intersección entre lo ancestral y lo contemporáneo, tejiendo un diálogo visual potente entre la inmensidad del paisaje patagónico y la vibrante experiencia urbana moderna.</strong>
                    </p>

                    <p class="text-base text-text-muted leading-relaxed">
                        Cada pieza es un puente hacia lo inhóspito y lo íntimo. Su técnica no solo captura la dualidad de un paisaje vasto, sino que también ofrece una mirada profunda y reflexiva sobre el alma de ese territorio.
                    </p>

                </div>
                <div class="flex justify-center">
                    <div class="w-80 h-80 rounded-sm overflow-hidden border-2 border-pantone-magenta/50 shadow-2xl">
                        <img src="./img/img_perfil.jpg" 
                            alt="Retrato de Francisco Fernández, artista plástico de la Patagonia."
                            class="w-full h-full object-cover"/>
                    </div>
                </div>
                </div>
        </div>
    </section>

    <section id="gallery-section" class="py-20 bg-bg-principal">
        <div class="max-w-7xl mx-auto px-6">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-light text-text-dark mb-8">
                    Catálogo de Obras
                </h2>
                <div class="w-16 h-px bg-pantone-magenta mx-auto"></div>
            </div>

            <div class="mb-8 flex flex-wrap gap-4 items-center bg-bg-card p-4 rounded-sm shadow-inner max-w-5xl mx-auto border border-border-light">
                <input id="search" type="search" placeholder="Buscar por título, técnica o descripción..."
                    class="flex-1 min-w-[200px] p-3 rounded-sm border border-border-light shadow-sm focus:outline-none focus:ring-1 focus:ring-pantone-magenta bg-white text-text-dark transition-colors" />
                
                <select id="filter-category" class="p-3 rounded-sm border border-border-light bg-white text-text-dark shadow-sm focus:ring-1 focus:ring-pantone-magenta">
                    <option value="">Todas las categorías</option>
                    <option value="grabado">Grabado</option>
                    <option value="dibujo">Dibujo</option>
                    <option value="pintura">Pintura</option>
                </select>

                <select id="filter-series" class="p-3 rounded-sm border border-border-light bg-white text-text-dark shadow-sm focus:ring-1 focus:ring-pantone-magenta">
                    <option value="">Todas las series</option>
                </select>

                <select id="filter-year" class="p-3 rounded-sm border border-border-light bg-white text-text-dark shadow-sm focus:ring-1 focus:ring-pantone-magenta">
                    <option value="">Todos los años</option>
                </select>

                <div id="admin-controls" class="hidden flex gap-2">
                    <button id="edit-toggle" class="p-3 rounded-sm bg-border-light hover:bg-pantone-magenta transition duration-300 text-text-dark hover:text-white text-sm">
                        Activar Edición
                    </button>
                    <button id="save-order-button" class="hidden p-3 rounded-sm bg-green-600 hover:bg-green-700 text-white transition duration-300 text-sm" disabled>
                        Guardar Orden
                    </button>
                </div>
            </div>
            
            <p id="status" class="text-center text-red-500 font-semibold mb-8"></p>

            <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                </div>
        </div>
    </section>

    <footer id="main-footer" class="fixed bottom-0 left-0 right-0 footer-gradient bg-opacity-95 backdrop-blur-sm border-t border-border-light p-3 z-40 translate-y-full transition-transform duration-500">
        <div class="max-w-7xl mx-auto flex justify-between items-center text-sm text-text-muted">
            <div class="font-light">
                © 2025 Francisco Fernández. Todos los derechos reservados.
            </div>
            <nav class="space-x-4">
                <a href="#bio-section" class="hover:text-pantone-magenta transition-colors">Bio</a>
                <a href="mailto:ffran.arte@gmail.com" class="hover:text-pantone-magenta transition-colors">Contacto</a>
                <a href="https://www.instagram.com/fran.faf/?hl=es" target="_blank" class="hover:text-pantone-magenta transition-colors">Instagram</a>
            </nav>
        </div>
    </footer>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <div id="modal-container" class="bg-bg-card rounded-sm shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
               <div class="flex justify-end p-4">
                <button onclick="closeModal()" class="text-text-muted hover:text-pantone-magenta text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 pt-0">
                </div>
        </div>
    </div>

    <script>
        // Inicialización de Supabase usando config.js
        const supabaseUrl = window.supabaseUrl;
        const supabaseAnonKey = window.supabaseAnonKey;
        const client = supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        let productos = [];
        let isEditing = false;
        let sortableInstance = null;
        
        const galleryContainer = document.getElementById("gallery-container");
        const status = document.getElementById("status");
        const loadingOverlay = document.getElementById("loading-overlay");
        const modal = document.getElementById("modal");
        const modalContent = document.getElementById("modal-content");
        const alertDiv = document.getElementById('alert');

        // Elementos de Filtro
        const searchInput = document.getElementById("search");
        const filterYear = document.getElementById("filter-year");
        const filterCategory = document.getElementById("filter-category");
        const filterSeries = document.getElementById("filter-series");

        // Elementos de Control de Administrador
        const adminControls = document.getElementById("admin-controls");
        const editToggleButton = document.getElementById("edit-toggle");
        const saveOrderButton = document.getElementById("save-order-button");

        // Elementos de interacción dinámica
        const whatsappButton = document.getElementById('whatsapp-btn');
        const mainFooter = document.getElementById('main-footer');
        // Usamos el punto de scroll de la galería para la visibilidad
        const gallerySection = document.getElementById('gallery-section');


        // --- FUNCIONES DE UTILIDAD ---
        function showAlert(message, type = 'success') {
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            alertDiv.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (type === 'error') {
                alertDiv.classList.add('bg-red-100', 'text-red-700');
            } else {
                alertDiv.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => alertDiv.classList.add('hidden'), 5000);
        }
        window.showAlert = showAlert;

        // --- LÓGICA DE SEGURIDAD: VERIFICACIÓN DE ADMIN ---
        async function checkAdminStatus() {
            try {
                const { data: { session } } = await client.auth.getSession();
                if (session) {
                    adminControls.classList.remove('hidden');
                } else {
                    adminControls.classList.add('hidden');
                }
            } catch(e) {
                 console.warn("Error checking admin status:", e);
            }
        }


        // --- FUNCIONES CORE ---
        function normalize(p) {
            const images = p.imagenes || [];
            return {
                id: p.id,
                title: p.titulo || "", 
                technique: p.tecnica || "", 
                size: p.medidas || "", 
                year: p.anio || 0, 
                description: p.descripcion || "",
                order: p.orden || 0,
                category: p.categoria || "",
                serie: p.serie || "",
                images,
                mainImage: (images.length ? images[0].url : "")
            };
        }
        
        function renderGallery(items) {
            galleryContainer.innerHTML = '';
            if (items.length === 0) {
                galleryContainer.innerHTML = '<p class="col-span-full text-center text-text-muted">No se encontraron obras que coincidan con los filtros.</p>';
                return;
            }

            items.forEach(obra => {
                const card = document.createElement("div");
                // Asegurar que la tarjeta tenga el cursor pointer en modo normal
                card.className = "bg-bg-card rounded-sm overflow-hidden cursor-pointer shadow-lg hover:shadow-xl transition duration-500 transform hover:-translate-y-1 group border border-border-light";
                card.setAttribute('data-id', obra.id); 
                card.setAttribute('onclick', `openModal(${obra.id})`);
                
                // Remover hover:rotate-1 ya que puede ser molesto
                
                card.innerHTML = `
                    <div class="aspect-[4/3] overflow-hidden">
                        <img src="${obra.mainImage}" alt="Obra de Francisco Fernández: ${obra.title}, ${obra.technique}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105" onerror="this.onerror=null;this.src='[URL_IMAGEN_DEFAULT]';" />
                    </div>
                    <div class="p-4 border-t border-border-light">
                        <h3 class="text-xl font-medium text-text-dark">${obra.title}</h3>
                        <p class="text-sm text-text-muted">${obra.technique} · <span class="text-pantone-magenta font-semibold">${obra.year}</span></p>
                    </div>
                `;
                galleryContainer.appendChild(card);
            });
            
            if (isEditing) {
                enableSorting();
            }
        }
        
        // --- FUNCIÓN INITGALLERY MÁS ROBUSTA CON TRY/CATCH ---
        async function initGallery() {
            status.textContent = "Cargando obras...";
            loadingOverlay.classList.remove('hidden');

            try {
                const { data, error } = await client
                    .from('productos')
                    .select('*')
                    .order('orden', { ascending: true }) 
                    .order('anio', { ascending: false }); 

                loadingOverlay.classList.add('hidden');
                
                if (error) {
                    // Si hay un error de Supabase (ej: RLS o conexión), lanza una excepción
                    throw new Error(`Error de Supabase: ${error.message}`);
                }

                productos = data.map(normalize);
                // Ordenar por 'orden', luego por 'anio' si 'orden' es el mismo o nulo
                productos.sort((a, b) => {
                    if (a.order !== b.order) {
                        // Tratar null/0 para 'orden' al final (o al inicio dependiendo de la preferencia. Aquí se prefiere el orden numérico bajo primero)
                        if (!a.order) return 1;
                        if (!b.order) return -1;
                        return a.order - b.order; 
                    }
                    return b.year - a.year; 
                });

                // Poblar Filtros (Año)
                const years = [...new Set(productos.map(a => a.year).filter(Boolean))].sort((a, b) => b - a);
                filterYear.innerHTML = '<option value="">Todos los años</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');

                // Poblar Filtros (Serie)
                const series = [...new Set(productos.map(a => a.serie).filter(s => s && s.trim() !== ''))].sort((a, b) => a.localeCompare(b));
                filterSeries.innerHTML = '<option value="">Todas las series</option>' + series.map(s => `<option value="${s}">${s}</option>`).join('');

                applyFilters(); // Aplicar filtros después de cargar, para que muestre el estado inicial
                status.textContent = "";

                await checkAdminStatus(); 
            } catch (e) {
                // Si algo falla, esconde la capa de carga y muestra el error en la pantalla.
                loadingOverlay.classList.add('hidden');
                status.textContent = `¡ERROR AL CARGAR LA GALERÍA! Verifique su archivo config.js o las Políticas RLS de Supabase. Detalle: ${e.message}`;
                console.error("Error crítico al cargar initGallery:", e);
            }
        }
        
        function applyFilters() {
            const q = searchInput.value.trim().toLowerCase();
            const y = filterYear.value;
            const c = filterCategory.value;
            const s = filterSeries.value;

            let filtered = productos.filter(p => {
                const hay = `${p.title || ""} ${p.technique || ""} ${p.year || ""} ${p.description || ""} ${p.serie || ""} ${p.category || ""}`.toLowerCase();
                
                let textMatch = hay.includes(q);
                let yearMatch = y ? String(p.year) === y : true;
                let categoryMatch = c ? String(p.category).toLowerCase() === c : true;
                let seriesMatch = s ? String(p.serie) === s : true;

                return textMatch && yearMatch && categoryMatch && seriesMatch;
            });

            renderGallery(filtered);
        }

        // --- LÓGICA DE REORDENAMIENTO (MANTENIDA) ---
        function enableSorting() {
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(galleryContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        saveOrderButton.disabled = false;
                        saveOrderButton.textContent = "Guardar Orden (Cambios Pendientes)";
                        saveOrderButton.classList.add('bg-pantone-magenta', 'hover:bg-opacity-80', 'text-white');
                        saveOrderButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }
                },
            });
        }
        
        editToggleButton.addEventListener('click', () => {
            isEditing = !isEditing;
            
            if (isEditing) {
                editToggleButton.textContent = 'Salir de Edición';
                editToggleButton.classList.replace('bg-border-light', 'bg-red-500');
                editToggleButton.classList.replace('hover:bg-pantone-magenta', 'hover:bg-red-600');
                editToggleButton.classList.remove('text-text-dark');
                editToggleButton.classList.add('text-white');

                saveOrderButton.classList.remove('hidden');
                galleryContainer.style.cursor = 'grab';
                applyFilters(); // Re-renderizar para activar el Sortable
            } else {
                editToggleButton.textContent = 'Activar Edición';
                editToggleButton.classList.replace('bg-red-500', 'bg-border-light');
                editToggleButton.classList.replace('hover:bg-red-600', 'hover:bg-pantone-magenta');
                editToggleButton.classList.add('text-text-dark');
                editToggleButton.classList.remove('text-white'); 
                
                saveOrderButton.classList.add('hidden');
                galleryContainer.style.cursor = 'default';
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
                initGallery(); // Recargar la galería en orden guardado al salir
            }
        });

        saveOrderButton.addEventListener('click', async () => {
            saveOrderButton.disabled = true;
            saveOrderButton.textContent = "Guardando...";
            saveOrderButton.classList.remove('bg-pantone-magenta', 'hover:bg-opacity-80', 'text-white');
            saveOrderButton.classList.add('bg-gray-500', 'hover:bg-gray-600', 'text-white'); 
            
            const cardElements = galleryContainer.querySelectorAll('[data-id]');
            const updates = [];

            cardElements.forEach((card, index) => {
                const obraId = parseInt(card.getAttribute('data-id'));
                const newOrder = index + 1;
                
                // Solo necesitamos enviar el ID y el nuevo orden para el update
                updates.push({ id: obraId, orden: newOrder });
            });
            
            // Usamos update en lugar de upsert con un array de objetos ligeros
            const { error } = await client
                .from('productos')
                .upsert(updates); 

            if (error) {
                status.textContent = `Error al guardar el orden: ${error.message}`;
                console.error(error);
                saveOrderButton.textContent = "Error al Guardar";
            } else {
                status.textContent = "Orden guardado exitosamente!";
                
                // --- CORRECCIÓN CRÍTICA: Recargar la galería con el nuevo orden ---
                await initGallery();
                // -----------------------------------------------------------------
                
                saveOrderButton.textContent = "Orden Guardado";
                saveOrderButton.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                saveOrderButton.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'bg-pantone-magenta'); 
            }
            
            saveOrderButton.disabled = false; // Re-habilitar si es necesario, aunque en el flujo de edición es mejor que el botón quede en 'Guardado'
        });


        // --- LÓGICA DE GUARDADO DE CAMBIOS DESDE EL MODAL ---
        async function saveModalChanges(event, id) {
            event.preventDefault(); 
            
            const form = event.target;
            const saveButton = form.querySelector('button[type="submit"]');

            const updatedData = {
                titulo: form.titulo.value.trim(),
                anio: parseInt(form.anio.value.trim()),
                tecnica: form.tecnica.value.trim(),
                medidas: form.medidas.value.trim(),
                categoria: form.categoria.value,
                serie: form.serie.value.trim(),
                descripcion: form.descripcion.value.trim(),
            };

            saveButton.textContent = "Guardando...";
            saveButton.disabled = true;
            
            const { error } = await client
                .from('productos')
                .update(updatedData)
                .eq('id', id);

            if (error) {
                showAlert(`Error al guardar: ${error.message}. ¿Tiene las Políticas RLS de UPDATE configuradas?`, 'error');
            } else {
                showAlert("¡Obra actualizada exitosamente!", 'success');
                closeModal();
                await initGallery(); // Recargar la galería para mostrar los cambios
            }

            saveButton.textContent = "Guardar Cambios";
            saveButton.disabled = false;
        }
        window.saveModalChanges = saveModalChanges;


        // --- MODAL LÓGICA ---
        function openModal(id) {
            const obra = productos.find(p => p.id === parseInt(id));
            if (!obra) return;
            
            modalContent.innerHTML = '';
            
            const whatsappNumber = '+5492805032663'; 
            const whatsappMessage = encodeURIComponent(`¡Hola, Francisco! Vi esta obra en tu galería web y me encantaría saber más. El título es: ${obra.title}.`);
            const whatsappLink = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;
            
            let modalHtml;

            if (isEditing) {
                // MODO EDICIÓN: RENDERIZAR FORMULARIO
                modalHtml = `
                    <form id="edit-form" onsubmit="saveModalChanges(event, ${obra.id})">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="md:h-[65vh] h-80 overflow-hidden flex items-center justify-center bg-bg-principal rounded-sm">
                                <img src="${obra.mainImage}" alt="Imagen de la obra ${obra.title}" class="max-w-full max-h-full object-contain" />
                            </div>
                            
                            <div>
                                <input name="titulo" value="${obra.title}" class="text-3xl font-light w-full text-text-dark mb-2 border-b border-pantone-magenta focus:outline-none p-1" required />
                                <input name="anio" type="number" value="${obra.year}" class="text-xl text-pantone-magenta mb-4 w-20 border-b border-pantone-magenta focus:outline-none p-1" required />
                                
                                <div class="space-y-3 text-text-dark mb-6 border-b border-border-light pb-4">
                                    <p class="text-sm">
                                        <strong class="text-text-dark">Categoría:</strong>
                                        <select name="categoria" class="ml-2 border border-border-light rounded-sm p-1 text-text-dark">
                                            <option value="grabado" ${obra.category === 'grabado' ? 'selected' : ''}>Grabado</option>
                                            <option value="dibujo" ${obra.category === 'dibujo' ? 'selected' : ''}>Dibujo</option>
                                            <option value="pintura" ${obra.category === 'pintura' ? 'selected' : ''}>Pintura</option>
                                        </select>
                                    </p>
                                    <p class="text-sm"><strong class="text-text-dark">Serie:</strong> <input name="serie" value="${obra.serie || ''}" class="ml-2 border-b border-border-light focus:outline-none p-1 w-2/3 text-text-dark" /></p>
                                    <p class="text-sm"><strong class="text-text-dark">Técnica:</strong> <input name="tecnica" value="${obra.technique}" class="ml-2 border-b border-border-light focus:outline-none p-1 w-2/3 text-text-dark" required /></p>
                                    <p class="text-sm"><strong class="text-text-dark">Medidas:</strong> <input name="medidas" value="${obra.size}" class="ml-2 border-b border-border-light focus:outline-none p-1 w-2/3 text-text-dark" required /></p>
                                </div>
                                
                                <h3 class="text-xl font-medium border-b border-border-light pb-1 mb-2 text-text-dark">Descripción</h3>
                                <textarea name="descripcion" class="text-text-muted whitespace-pre-wrap text-sm w-full h-32 border border-border-light p-2 focus:border-pantone-magenta rounded-sm">${obra.description || 'Sin descripción.'}</textarea>
                                
                                <div class="mt-8 flex flex-wrap gap-3 pt-4 border-t border-border-light" id="thumbnail-container">
                                    ${obra.images.map(img => `
                                        <img src="${img.url}" alt="Miniatura de ${obra.title}" class="h-16 w-16 object-cover rounded-sm shadow border border-border-light" />
                                    `).join('')}
                                </div>

                                <button type="submit" class="mt-8 w-full inline-flex text-center py-3 px-6 rounded-sm bg-pantone-magenta hover:bg-opacity-80 text-white font-semibold transition-colors items-center justify-center shadow-md">
                                    Guardar Cambios
                                </button>
                                <button type="button" onclick="closeModal()" class="mt-4 w-full py-3 px-6 rounded-sm bg-border-light hover:bg-gray-300 text-text-dark font-semibold transition-colors items-center justify-center shadow-md">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </form>
                `;
            } else {
                // MODO LECTURA: RENDERIZAR VISTA NORMAL (CON ZOOM Y WHATSAPP)
                modalHtml = `
                    <div class="grid md:grid-cols-2 gap-8">
                        <div id="zoom-container-${id}" class="md:h-[65vh] h-80 overflow-hidden flex items-center justify-center bg-bg-principal rounded-sm zoom-container">
                            <div class="zoom-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                            </div>
                            <img id="modal-main-image-${id}" src="${obra.mainImage}" alt="Detalle de la obra de Francisco Fernández: ${obra.title}" class="max-w-full max-h-full object-contain zoom-image" />
                        </div>

                        <div>
                            <h2 class="text-3xl font-light text-text-dark mb-2">${obra.title}</h2>
                            <p class="text-xl text-pantone-magenta mb-4">${obra.year}</p>
                            
                            <div class="space-y-3 text-text-dark mb-6 border-b border-border-light pb-4">
                                <p class="text-sm"><strong>Categoría:</strong> ${obra.category || 'N/A'}</p>
                                <p class="text-sm"><strong>Serie:</strong> ${obra.serie || 'N/A'}</p>
                                <p class="text-sm"><strong>Técnica:</strong> ${obra.technique}</p>
                                <p class="text-sm"><strong>Medidas:</strong> ${obra.size}</p>
                            </div>
                            
                            <h3 class="text-xl font-medium border-b border-border-light pb-1 mb-2 text-text-dark">Descripción</h3>
                            <p class="text-text-muted whitespace-pre-wrap text-sm">${obra.description || 'Sin descripción.'}</p>
                            
                            <div class="mt-8 flex flex-wrap gap-3 pt-4 border-t border-border-light" id="thumbnail-container-${id}">
                                ${obra.images.map(img => `
                                    <img src="${img.url}" alt="Miniatura de ${obra.title}" class="h-16 w-16 object-cover rounded-sm shadow cursor-pointer border border-border-light hover:border-pantone-magenta transition-colors" 
                                        data-url="${img.url}" />
                                `).join('')}
                            </div>

                            <a href="${whatsappLink}" target="_blank" 
                            class="mt-8 w-full md:w-auto inline-flex text-center py-3 px-6 rounded-sm bg-whatsapp hover:bg-green-600 text-white font-semibold transition-colors items-center justify-center space-x-2 shadow-md">
                                <svg fill="#FFF" viewBox="0 0 24 24" width="20" height="20" class="whatsapp-icon"><path d="M12 2C6.48 2 2 6.48 2 12c0 3.25 1.5 6.2 3.88 8.1l-1.38 5.02L7.6 21.62C9.5 22.18 11.08 22 12 22c5.52 0 10-4.48 10-10C22 6.48 17.52 2 12 2zM17.43 15.4c-.09-.15-.36-.24-.77-.42-.42-.18-2.52-1.24-2.91-1.38-.39-.14-.67-.21-.95.21-.28.42-1.09 1.38-1.34 1.66-.25.28-.5.31-.92.21-.42-.1-.71-.34-1.27-.64-.47-.25-1.07-.65-2.03-1.89-.75-.98-1.25-1.95-1.38-2.2-.14-.25-.02-.38.11-.5.1-.11.23-.26.35-.4.12-.14.16-.25.25-.42.09-.17.04-.32-.02-.45-.06-.13-.57-1.36-.78-1.87-.2-.5-.41-.42-.56-.42-.15 0-.33-.02-.51-.02-.18 0-.47.07-.72.35-.25.28-.95.93-.95 2.27 0 1.34.97 2.64 1.1 2.82.13.18 1.92 3.03 4.6 4.24 2.68 1.21 2.68.85 2.97.8.29-.05.95-.39 1.08-.77.13-.38.13-.7.09-.77z"/></svg>
                                <span>Consultar por esta Obra</span>
                            </a>
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = modalHtml;

            // Lógica de Zoom y Thumbnails solo se aplica en modo lectura
            if (!isEditing) {
                const zoomContainer = document.getElementById(`zoom-container-${id}`);
                const mainImage = document.getElementById(`modal-main-image-${id}`);
                
                if (zoomContainer) {
                    zoomContainer.addEventListener('mousemove', handleZoom);
                    zoomContainer.addEventListener('mouseleave', () => resetZoom(zoomContainer));
                }
                
                // --- CORRECCIÓN DE THUMBNAILS ---
                document.querySelectorAll(`#thumbnail-container-${id} img`).forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        mainImage.src = thumb.getAttribute('data-url');
                        resetZoom(zoomContainer); // Resetear zoom al cambiar de imagen
                    });
                });
            }


            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(event) {
            // Se asegura de cerrar si se hace clic en el fondo oscuro o en el botón de cerrar.
            if (!event || event.target.id === 'modal' || event.target.tagName === 'BUTTON' || event.target.closest('button')) { 
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // Asignar el listener de cerrar al botón de la X
        document.querySelector('#modal-container .flex.justify-end button').onclick = closeModal;


        
        // --- LÓGICA DE ZOOM Y SCROLL (MANTENIDA) ---
        function handleZoom(event) {
            const container = event.currentTarget;
            const img = container.querySelector('.zoom-image');
            if (!img) return;
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left; 
            const y = event.clientY - rect.top;  
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;
            const zoomScale = 2.5; 
            img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
            img.style.transform = `scale(${zoomScale})`;
        }
        
        function resetZoom(container) {
            const img = container.querySelector('.zoom-image');
            if (img) {
                img.style.transform = null; 
                img.style.transformOrigin = 'center center';
            }
        }

        const firstSection = document.querySelector('section.min-h-screen'); 
        
        window.addEventListener('scroll', () => {
            if (!firstSection) return;
            
            const firstSectionHeight = firstSection.offsetHeight;
            
            // Lógica del Footer
            if (window.scrollY > firstSectionHeight - 100) { 
                mainFooter.classList.remove('translate-y-full');
            } else {
                mainFooter.classList.add('translate-y-full');
            }

            // Lógica del Botón de WhatsApp
            // Obtenemos la posición de la sección de galería dinámicamente
            const gallerySectionTop = gallerySection ? gallerySection.offsetTop : firstSectionHeight;
            if (window.scrollY > gallerySectionTop - window.innerHeight / 2) { 
                whatsappButton.classList.add('show');
            } else {
                whatsappButton.classList.remove('show');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            mainFooter.classList.add('translate-y-full');
            whatsappButton.classList.remove('show');
        });

        // Event Listeners de Filtro
        searchInput.addEventListener("input", applyFilters);
        filterYear.addEventListener("change", applyFilters);
        filterCategory.addEventListener("change", applyFilters);
        filterSeries.addEventListener("change", applyFilters);


        // Inicializar
        document.addEventListener('DOMContentLoaded', initGallery);

    </script>
</body>
</html>