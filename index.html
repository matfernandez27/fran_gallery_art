<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Francisco Fernández | Galería de Arte Patagónico, Dibujo y Grabado Contemporáneo</title>
    
    <meta name="description" content="Galería oficial de Francisco Fernández. Descubre obras de arte patagónico, grabados, dibujos y pintura que exploran la dualidad entre lo ancestral y lo moderno.">

    <meta property="og:title" content="Francisco Fernández - Arte Patagónico y Grabado Contemporáneo">
    <meta property="og:description" content="Descubre la Galería Personal de Francisco Fernández: un diálogo visual entre la inmensidad de la Patagonia y la experiencia urbana moderna.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fran-faf.vercel.app/">
    <meta property="og:image" content="[URL_IMAGEN_DESTACADA]"> 
    <meta property="og:locale" content="es_AR">

    <link rel="icon" type="image/png" href="./img/favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de colores personalizados (VIVO Y CLARO)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pantone-magenta': '#DE3B89', // PANTONE 17-2036 TPG/TCX (Acento)
                        'bg-principal': '#FAEBF0',    // Fondo Principal (Magenta muy pálido)
                        'bg-card': '#FFFFFF',         // Fondo de Tarjetas/Secciones (Blanco puro)
                        'text-dark': '#333333',       // Texto principal (Gris oscuro)
                        'text-muted': '#666666',      // Texto secundario (Gris medio)
                        'border-light': '#E0E0E0',    // Bordes y líneas divisorias (Gris claro)
                        'whatsapp': '#25D366',        // Verde de WhatsApp
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    
    <style>
        /* Estilos del Overlay de Carga (Spinner) */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(250, 235, 240, 0.95);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .lds-ring div { 
            box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; 
            border: 8px solid #DE3B89;
            border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; 
            border-color: #DE3B89 transparent transparent transparent;
        }
        
        /* --- ESTILOS DEL CARRUSEL DE FONDO (DINÁMICO) --- */
        #carousel-header {
            position: relative;
            overflow: hidden;
        }
        .carousel-item {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: contain; 
            background-position: center;
            background-repeat: no-repeat;
            background-color: #F5E5EC; 
            opacity: 0;
            transition: opacity 1.5s ease-in-out; 
            transform: scale(1.05); 
        }
        .carousel-item.active {
            opacity: 1;
            transform: scale(1);
        }
        .carousel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(250, 235, 240, 0.5); 
            z-index: 1;
        }
        
        /* --- ESTILOS DE LA BIOGRAFÍA: CORRECCIÓN DE POSICIÓN Y CENTRADO DE FOTO --- */
        #bio-section .grid {
            align-items: start;
        }
        
        .bio-image-container {
            display: flex; 
            justify-content: center; 
        }

        .bio-image-focus {
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: top center; 
        }

        /* Estilo del Botón Flotante de WhatsApp */
        .whatsapp-float-btn {
            position: fixed; bottom: 60px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            z-index: 50; transition: transform 0.3s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0; 
            pointer-events: none; 
        }
        .whatsapp-float-btn.show { opacity: 1; pointer-events: auto; }
        .whatsapp-float-btn:hover { transform: scale(1.1); }

        /* --- ESTILOS DE ZOOM INTERACTIVO --- */
        .zoom-container {
            position: relative; overflow: hidden; cursor: crosshair; 
        }
        .zoom-image {
            width: 100%; height: 100%; object-fit: contain; 
            transition: transform 0.3s ease-in-out; 
            transform: scale(1); 
            transform-origin: center center;
        }
        .zoom-container:hover .zoom-image {
            transform: scale(2.5);
        }
        .zoom-icon {
            position: absolute; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.5); color: #333333; 
            padding: 8px; border-radius: 50%; z-index: 10; border: 1px solid #E0E0E0;
        }
        /* Estilo para el modo de ordenamiento */
        .sortable-ghost { opacity: 0.4; background-color: #DE3B89; border: 2px dashed #333333; } 
        /* Estilo para el footer con degradado */
        .footer-gradient { background: linear-gradient(to right, #F5E5EC, #FFFFFF); } 
        /* Estilo de alerta flotante */
        #alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; padding: 1rem; border-radius: 0.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); font-weight: 500; } 
        
        /* --- ESTILO PARA EL SCROLLBAR DEL MODAL DE DETALLE --- */
        .modal-scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .modal-scrollable::-webkit-scrollbar-track {
            background: #FAEBF0; /* bg-principal */
        }

        .modal-scrollable::-webkit-scrollbar-thumb {
            background-color: #DE3B89; /* pantone-magenta */
            border-radius: 20px;
            border: 2px solid #FAEBF0;
        }

    </style>
</head>
<body class="bg-bg-principal text-text-dark font-sans min-h-screen">

    <div id="loading-overlay" class="loading-overlay">
        <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
    </div>
    
    <div id="alert" class="hidden" role="alert"></div>

    <a id="whatsapp-float-btn" href="https://wa.me/XXXXXXXXXX" target="_blank" class="whatsapp-float-btn bg-whatsapp">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V10a2 2 0 012-2h2m0 0V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 4v4m0 0l-2-2m2 2l2-2" />
        </svg>
    </a>

    <header id="carousel-header" class="relative h-[80vh] min-h-[500px] flex items-center justify-center text-white">
        <div id="carousel-items-container">
            </div>
        <div class="carousel-overlay z-10"></div>
        
        <div class="relative z-20 text-center p-4">
            <h1 class="text-4xl sm:text-6xl font-extralight tracking-tight drop-shadow-lg text-pantone-magenta">
                Francisco Fernández
            </h1>
            <p class="text-xl sm:text-2xl font-light mt-2 drop-shadow-md text-text-dark">
                Arte Patagónico y Grabado Contemporáneo
            </p>
            <a href="#gallery-section" class="inline-block mt-8 bg-pantone-magenta hover:bg-opacity-80 text-white font-bold py-3 px-8 rounded-sm transition duration-300 text-sm uppercase tracking-wider shadow-xl">
                Ver Catálogo
            </a>
        </div>
    </header>

    <main>
        <section id="bio-section" class="bg-bg-card py-16 md:py-24 border-b border-border-light">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12 items-center">
                    
                    <div class="md:col-span-1 bio-image-container">
                        <img src="./img/francisco_ff.jpg" alt="Retrato de Francisco Fernández" class="bio-image-focus w-full max-w-sm md:max-w-none h-64 md:h-96 rounded-lg shadow-2xl object-cover object-center border-4 border-pantone-magenta/50">
                    </div>

                    <div class="md:col-span-2">
                        <h2 class="text-3xl font-light text-pantone-magenta mb-4">
                            Biografía
                        </h2>
                        <p class="text-lg text-text-dark leading-relaxed mb-4">
                            Francisco Fernández es un artista visual originario de la Patagonia, cuya obra se centra en el dibujo, el grabado y la pintura, explorando la dualidad entre lo ancestral y lo moderno. Su trabajo crea un diálogo visual potente, contrastando la inmensidad del paisaje patagónico con la experiencia urbana contemporánea.
                        </p>
                        <p class="text-base text-text-muted leading-relaxed mb-6">
                            A través de técnicas mixtas, logra capturar la textura y el silencio de la estepa, fusionándolos con la energía de la vida actual, utilizando paletas de colores que van desde los tonos terrosos hasta explosiones de magenta y cian.
                        </p>
                        <a href="./biografia-completa.html" 
                           class="inline-block text-pantone-magenta hover:text-text-dark font-semibold transition duration-300 text-sm uppercase tracking-wider border-b border-pantone-magenta hover:border-text-dark pb-0.5">
                            Leer biografía completa &rarr;
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <section id="gallery-section" class="py-16 md:py-24">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
                <h2 class="text-4xl font-extralight text-text-dark mb-10 border-b pb-4 text-center">
                    Catálogo de Obras
                </h2>

                <div class="flex flex-wrap items-center justify-center gap-4 mb-10 bg-white p-4 rounded-lg shadow-md border border-border-light">
                    
                    <input type="search" id="search-input" placeholder="Buscar por título o descripción..." 
                           class="flex-grow min-w-[200px] p-2 border border-border-light rounded-md text-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                    
                    <select id="filter-category" class="p-2 border border-border-light rounded-md text-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todas las Categorías</option>
                        <option value="grabado">Grabado</option>
                        <option value="dibujo">Dibujo</option>
                        <option value="pintura">Pintura</option>
                        <option value="tecnica-mixta">Técnica Mixta</option>
                    </select>

                    <select id="filter-year" class="p-2 border border-border-light rounded-md text-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todos los Años</option>
                        </select>

                    <select id="filter-series" class="p-2 border border-border-light rounded-md text-sm focus:ring-pantone-magenta focus:border-pantone-magenta">
                        <option value="">Todas las Series</option>
                        </select>

                </div>

                <div id="works-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    </div>

                <div id="no-results-message" class="hidden text-center mt-10 p-6 bg-white rounded-lg shadow-lg">
                    <p class="text-xl text-text-muted">No se encontraron obras que coincidan con los filtros aplicados.</p>
                </div>

            </div>
        </section>

        <section id="contact-section" class="bg-pantone-magenta text-white py-16 md:py-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl text-center">
                <h2 class="text-4xl font-extralight mb-6">¿Interesado en una Obra?</h2>
                <p class="text-lg mb-8 opacity-90">
                    Para consultas sobre disponibilidad, encargos o cotizaciones, por favor contáctame directamente.
                </p>
                <a href="mailto:francisco.ff@gmail.com" 
                   class="inline-block bg-white text-pantone-magenta hover:bg-gray-100 font-bold py-3 px-8 rounded-sm transition duration-300 text-sm uppercase tracking-wider shadow-lg mr-4">
                    Enviar Email
                </a>
                <a href="https://wa.me/XXXXXXXXXX" target="_blank"
                   class="inline-block bg-whatsapp hover:bg-green-700 text-white font-bold py-3 px-8 rounded-sm transition duration-300 text-sm uppercase tracking-wider shadow-lg">
                    Enviar WhatsApp
                </a>
            </div>
        </section>
    </main>

    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[1002] hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col relative" onclick="event.stopPropagation()">
            
            <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 z-[1003] p-2 bg-white rounded-full transition" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="p-6 overflow-y-auto modal-scrollable flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    
                    <div class="md:col-span-3 space-y-4">
                        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden">
                            <div id="modal-main-image-zoom-container" class="zoom-container w-full h-full">
                                <img id="modal-main-image" src="" alt="Imagen principal de la obra" class="zoom-image w-full h-full object-contain">
                                <div class="zoom-icon">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                                </div>
                            </div>
                        </div>
                        
                        <div id="modal-thumbnails" class="flex flex-wrap gap-2">
                            </div>
                    </div>

                    <div class="md:col-span-2 space-y-4 pt-4 md:pt-0">
                        <h3 id="modal-title" class="text-3xl font-bold text-text-dark"></h3>
                        <p class="text-sm text-text-muted border-b border-border-light pb-2">
                            <span id="modal-category" class="capitalize font-medium"></span>, <span id="modal-year"></span>
                        </p>
                        
                        <div class="space-y-2 text-text-dark">
                            <p id="modal-series" class="text-base"></p>
                            <p id="modal-dimensions" class="text-base"></p>
                            <p id="modal-description" class="text-base leading-relaxed"></p>
                        </div>

                        <div id="modal-status" class="pt-4 border-t border-border-light">
                            <p id="modal-availability" class="text-xl font-bold"></p>
                            <a id="modal-contact-btn" href="#" target="_blank"
                               class="inline-block mt-3 w-full bg-pantone-magenta hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-sm transition duration-300 text-sm uppercase tracking-wider shadow-md text-center">
                                Consultar Disponibilidad
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer id="main-footer" class="fixed bottom-0 left-0 w-full bg-bg-card shadow-lg z-30 transition-transform duration-500 ease-in-out transform translate-y-full border-t border-pantone-magenta/30 footer-gradient">
        <div class="container mx-auto px-4 py-4 flex flex-wrap justify-between items-center text-sm text-text-muted">
            <div class="w-full md:w-auto text-center md:text-left mb-2 md:mb-0">
                &copy; <span id="current-year"></span> Francisco Fernández | Arte Visual.
            </div>
            <div class="w-full md:w-auto text-center md:text-right">
                <a href="#" class="hover:text-pantone-magenta transition duration-150 mx-2">Términos</a>
                <span class="text-border-light">|</span>
                <a href="mailto:francisco.ff@gmail.com" class="hover:text-pantone-magenta transition duration-150 mx-2">Contacto</a>
            </div>
        </div>
    </footer>


    <script>
        // --- CONFIGURACIÓN DE SUPABASE Y CONSTANTES ---
        const client = supabase.createClient(window.supabaseUrl, window.supabaseAnonKey);
        const TABLE_NAME = 'works';
        const BUCKET_NAME = 'obras';
        
        // --- VARIABLES GLOBALES ---
        let allWorks = []; // Almacena todas las obras
        let displayedWorks = []; // Almacena las obras filtradas actualmente en la galería
        let isGalleryReady = false;

        // --- REFERENCIAS DOM ---
        const worksContainer = document.getElementById('works-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const searchInput = document.getElementById('search-input');
        const filterYear = document.getElementById('filter-year');
        const filterCategory = document.getElementById('filter-category');
        const filterSeries = document.getElementById('filter-series');
        const noResultsMessage = document.getElementById('no-results-message');
        const mainFooter = document.getElementById('main-footer');
        const whatsappButton = document.getElementById('whatsapp-float-btn');
        const gallerySection = document.getElementById('gallery-section');

        // --- UTILIDADES ---

        function getPublicUrl(path) {
             return `${window.supabaseUrl}/storage/v1/object/public/${BUCKET_NAME}/${path}`;
        }
        
        function showAlert(message, type = 'success') {
            const alertElement = document.getElementById('alert');
            alertElement.textContent = message;
            alertElement.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 text-sm rounded-lg shadow-xl z-50 ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} w-90 max-w-400`;
            alertElement.classList.remove('hidden');
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
        
        // --- GESTIÓN DE AUTH (Solo para verificar si está logueado y mostrar el enlace) ---

        async function checkAdminStatus() {
            const { data: { user } } = await client.auth.getUser();
            const adminLink = document.getElementById('admin-link');
            if (user && adminLink) {
                adminLink.classList.remove('hidden');
            }
        }

        // --- CARGA DE DATOS ---

        async function loadWorks() {
            loadingOverlay.classList.remove('hidden');
            try {
                const { data, error } = await client.from(TABLE_NAME)
                    .select('*')
                    .order('position', { ascending: true }); // Ordenar por posición
                
                if (error) throw error;
                allWorks = data;
                displayedWorks = data;
                
                populateFilters();
                applyFilters(); // Renderiza la galería inicial
                renderCarouselItems(allWorks); // Renderiza el carrusel
                isGalleryReady = true;

            } catch (error) {
                console.error("Error al cargar obras:", error);
                showAlert(`Error al cargar obras: ${error.message}`, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // --- GESTIÓN DE FILTROS ---

        function populateFilters() {
            // 1. Años
            const years = [...new Set(allWorks.map(w => w.anio).filter(Boolean))].sort((a, b) => b - a);
            filterYear.innerHTML = '<option value="">Todos los Años</option>';
            years.forEach(year => {
                filterYear.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // 2. Series
            const series = [...new Set(allWorks.map(w => w.serie).filter(Boolean))].sort();
            filterSeries.innerHTML = '<option value="">Todas las Series</option>';
            series.forEach(serie => {
                filterSeries.innerHTML += `<option value="${serie}">${serie}</option>`;
            });
        }


        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedYear = filterYear.value;
            const selectedCategory = filterCategory.value;
            const selectedSeries = filterSeries.value;

            displayedWorks = allWorks.filter(obra => {
                const matchesSearch = (obra.titulo.toLowerCase().includes(searchTerm) || 
                                     (obra.descripcion || '').toLowerCase().includes(searchTerm));
                
                const matchesYear = !selectedYear || String(obra.anio) === selectedYear;
                const matchesCategory = !selectedCategory || obra.categoria === selectedCategory;
                const matchesSeries = !selectedSeries || obra.serie === selectedSeries;

                return matchesSearch && matchesYear && matchesCategory && matchesSeries;
            });

            renderGallery(displayedWorks);
        }

        // --- RENDERIZADO DE GALERÍA Y DETALLE ---

        function renderGallery(works) {
            worksContainer.innerHTML = '';
            
            if (works.length === 0) {
                noResultsMessage.classList.remove('hidden');
                return;
            }

            noResultsMessage.classList.add('hidden');
            
            works.forEach(obra => {
                const mainImagePath = obra.imagen_principal_path || (obra.imagenes && obra.imagenes.length > 0 ? obra.imagenes[0].path : null);
                const imageUrl = obra.imagen_principal || (mainImagePath ? getPublicUrl(mainImagePath) : 'https://via.placeholder.com/400?text=No+Image');

                const card = document.createElement('div');
                card.className = 'bg-bg-card rounded-lg shadow-xl overflow-hidden transform hover:scale-[1.02] transition duration-300 cursor-pointer border border-border-light';
                card.setAttribute('onclick', `openModal(${obra.id})`);
                card.innerHTML = `
                    <div class="relative w-full aspect-[4/5] overflow-hidden">
                        <img src="${imageUrl}" alt="${obra.titulo}" 
                             class="w-full h-full object-cover transition duration-500 ease-in-out hover:opacity-90"
                             onerror="this.onerror=null;this.src='https://via.placeholder.com/400?text=Error+Loading'">
                        <div class="absolute top-0 left-0 p-3">
                            ${obra.destacada ? '<span class="px-3 py-1 text-xs font-semibold bg-pantone-magenta text-white rounded-full shadow-md">Destacada</span>' : ''}
                        </div>
                    </div>
                    <div class="p-4">
                        <h4 class="text-xl font-semibold text-text-dark truncate">${obra.titulo}</h4>
                        <p class="text-sm text-text-muted mt-1">${obra.categoria} (${obra.anio})</p>
                        <p class="text-lg font-bold mt-2 ${obra.disponible ? 'text-green-600' : 'text-text-muted'}">
                            ${obra.disponible ? 'Disponible' : 'Colección Privada'}
                        </p>
                    </div>
                `;
                worksContainer.appendChild(card);
            });
        }
        
        function openModal(id) {
            const obra = allWorks.find(w => w.id === id);
            if (!obra) return;

            const modal = document.getElementById('detail-modal');
            const mainImageContainer = document.getElementById('modal-main-image-zoom-container');
            const mainImage = document.getElementById('modal-main-image');
            const thumbnailsContainer = document.getElementById('modal-thumbnails');

            // --- 1. Llenar Información de Texto ---
            document.getElementById('modal-title').textContent = obra.titulo;
            document.getElementById('modal-category').textContent = obra.categoria;
            document.getElementById('modal-year').textContent = obra.anio;
            document.getElementById('modal-series').textContent = obra.serie ? `Serie: ${obra.serie}` : '';
            document.getElementById('modal-dimensions').textContent = obra.medidas || '';
            document.getElementById('modal-description').textContent = obra.descripcion || '';
            
            // --- 2. Llenar Disponibilidad y Botón de Contacto ---
            const availabilityText = document.getElementById('modal-availability');
            const contactBtn = document.getElementById('modal-contact-btn');
            
            if (obra.disponible) {
                availabilityText.textContent = 'DISPONIBLE para Adquisición';
                availabilityText.className = 'text-xl font-bold text-green-600';
                contactBtn.textContent = 'Consultar Precio y Adquisición';
                // Enlace a WhatsApp (asumiendo que XXXX es el número)
                contactBtn.href = `https://wa.me/XXXXXXXXXX?text=Hola%2C%20estoy%20interesado%20en%20la%20obra%20"${encodeURIComponent(obra.titulo)}"%20(${obra.anio}).%20%C2%BFMe%20podr%C3%ADas%20dar%20m%C3%A1s%20informaci%C3%B3n%3F`;
            } else {
                availabilityText.textContent = 'Colección Privada';
                availabilityText.className = 'text-xl font-bold text-text-muted';
                contactBtn.textContent = 'Consultar sobre Obra';
                contactBtn.href = `https://wa.me/XXXXXXXXXX?text=Hola%2C%20estoy%20interesado%20en%20consultar%20sobre%20la%20obra%20"${encodeURIComponent(obra.titulo)}"%20(${obra.anio}).%20`;
            }

            // --- 3. Llenar Galería y Miniaturas ---
            thumbnailsContainer.innerHTML = '';
            
            // Generar la lista de todas las imágenes
            const allImages = [];
            // Imagen principal (si existe una URL o un path de Storage)
            if (obra.imagen_principal) {
                allImages.push({ url: obra.imagen_principal, path: obra.imagen_principal_path, is_main: true });
            } else if (obra.imagen_principal_path) {
                 allImages.push({ url: getPublicUrl(obra.imagen_principal_path), path: obra.imagen_principal_path, is_main: true });
            }
            
            // Imágenes secundarias
            (obra.imagenes || []).forEach(img => {
                if (img.path) {
                    allImages.push({ url: getPublicUrl(img.path), path: img.path, is_main: false });
                }
            });
            
            // Si no hay ninguna imagen, usar placeholder
            if (allImages.length === 0) {
                 mainImage.src = 'https://via.placeholder.com/800?text=No+Image';
                 mainImage.dataset.path = '';
                 mainImage.dataset.url = '';
            } else {
                // Establecer la primera imagen como principal en el modal
                const initialImage = allImages[0];
                mainImage.src = initialImage.url;
                mainImage.dataset.path = initialImage.path || '';
                mainImage.dataset.url = initialImage.url;
            
                // Crear miniaturas
                allImages.forEach((img, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = img.url;
                    thumbnail.alt = `Vista ${index + 1}`;
                    thumbnail.className = 'w-16 h-16 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-pantone-magenta transition duration-150';
                    thumbnail.dataset.path = img.path || '';
                    thumbnail.dataset.url = img.url;
                    thumbnail.onclick = () => {
                        mainImage.src = thumbnail.dataset.url;
                        mainImage.dataset.path = thumbnail.dataset.path;
                        document.querySelectorAll('#modal-thumbnails img').forEach(t => t.classList.remove('border-pantone-magenta'));
                        thumbnail.classList.add('border-pantone-magenta');
                    };
                    if (index === 0) {
                         thumbnail.classList.add('border-pantone-magenta');
                    }
                    thumbnailsContainer.appendChild(thumbnail);
                });
            }

            // --- 4. Mostrar Modal ---
            mainImageContainer.onmousemove = (e) => {
                 if (mainImage.dataset.path) {
                    const rect = mainImageContainer.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width * 100;
                    const y = (e.clientY - rect.top) / rect.height * 100;
                    mainImage.style.transformOrigin = `${x}% ${y}%`;
                }
            };
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }


        // --- RENDERIZADO DEL CARRUSEL ---

        function renderCarouselItems(works) {
            const container = document.getElementById('carousel-items-container');
            container.innerHTML = '';
            
            // Filtrar y obtener solo las obras destacadas
            const featuredWorks = works.filter(w => w.destacada && (w.imagen_principal || w.imagen_principal_path));
            
            if (featuredWorks.length === 0) {
                // Si no hay destacadas, usar la primera imagen del sitio como fallback
                container.innerHTML = `<div class="carousel-item active" style="background-image: url('./img/hero-fallback.jpg');"></div>`;
                return;
            }
            
            // Mapear obras a URLs
            const carouselImages = featuredWorks.map(w => w.imagen_principal || getPublicUrl(w.imagen_principal_path));

            carouselImages.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.style.backgroundImage = `url('${url}')`;
                container.appendChild(item);
            });

            if (carouselImages.length > 1) {
                startCarousel(container, carouselImages.length);
            }
        }
        
        function startCarousel(container, count) {
            let currentIndex = 0;
            const items = container.querySelectorAll('.carousel-item');
            
            setInterval(() => {
                // Quitar 'active' del elemento actual
                items[currentIndex].classList.remove('active');
                
                // Mover al siguiente índice
                currentIndex = (currentIndex + 1) % count;
                
                // Añadir 'active' al nuevo elemento
                items[currentIndex].classList.add('active');
            }, 5000); // Cambia de imagen cada 5 segundos
        }

        // --- MANEJO DE SCROLL (Footer y WhatsApp) ---

        const firstSection = document.querySelector('section#carousel-header'); 
        
        window.addEventListener('scroll', () => {
            if (!firstSection) return;
            
            const firstSectionHeight = firstSection.offsetHeight;
            
            // Lógica del Footer
            if (window.scrollY > firstSectionHeight - 100) { 
                mainFooter.classList.remove('translate-y-full');
            } else {
                mainFooter.classList.add('translate-y-full');
            }

            // Lógica del Botón de WhatsApp
            // Solo mostrar el botón de WA después de que pase el carrusel (o mitad de galería si es más pequeña)
            const gallerySectionTop = gallerySection ? gallerySection.offsetTop : firstSectionHeight;
            if (window.scrollY > gallerySectionTop - window.innerHeight / 2) { 
                whatsappButton.classList.add('show');
            } else {
                whatsappButton.classList.remove('show');
            }
        });

        // Event Listeners de Filtro
        searchInput.addEventListener("input", applyFilters);
        filterYear.addEventListener("change", applyFilters);
        filterCategory.addEventListener("change", applyFilters);
        
        // El listener de filterSeries se adjunta de forma segura aquí
        if (filterSeries) {
            filterSeries.addEventListener("change", applyFilters);
        }


        // Inicializar la Galería y Auth (CORRECCIÓN FINAL: Bloque movido al final del script)
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer el año actual en el footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Ocultar elementos al cargar para una transición suave
            mainFooter.classList.add('translate-y-full');
            whatsappButton.classList.remove('show');
            
            // Cargar datos
            loadWorks(); 
            
            // Verificar sesión de administrador
            checkAdminStatus();
        });

    </script>
</body>
</html>